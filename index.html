<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>快捷Excel数据处理工具 - 优化版</title>
    <!-- 引入外部资源 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    
    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFC9',
                        success: '#52C41A',
                        warning: '#FAAD14',
                        danger: '#FF4D4F',
                        neutral: '#8C8C8C',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .table-shadow {
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            }
            .hover-scale {
                transition: transform 0.2s;
            }
            .hover-scale:hover {
                transform: scale(1.02);
            }
            .dimension-area-active {
                background-color: rgba(22, 93, 255, 0.05);
                border-color: #165DFF;
            }
            .field-type-icon {
                width: 20px;
                height: 20px;
                border-radius: 3px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                margin-right: 5px;
                font-size: 12px;
            }
        }
    </style>
</head>

<body class="bg-gray-50 font-sans text-gray-800">
    <!-- 隐私提示条 -->
    <div id="privacyBar" class="bg-primary/10 border-b border-primary/20 py-2 px-4" data-bar="privacy">
        <div class="container mx-auto flex items-center justify-between text-sm">
            <div class="flex items-center">
                <i class="fa fa-shield text-primary mr-2"></i>
                <span>您的数据仅在本地浏览器中处理，不会上传至任何服务器！</span>
            </div>
            <button id="hidePrivacyBar" class="text-primary hover:text-primary/80">
                <i class="fa fa-times"></i>
            </button>
        </div>
    </div>
    <!-- 导入数据格式提示 -->
    <div id="importFormatBar" class="bg-primary/10 border-b border-primary/20 py-2 px-4" data-bar="import-format">
        <div class="container mx-auto flex items-center justify-between text-sm">
            <div class="flex items-center">
                <i class="fa fa-info-circle text-primary mr-2"></i>
                <span>导入的Excel表格，需要去除表头（标题）！</span>
            </div>
            <button id="hideImportFormatBar" class="text-primary hover:text-primary/80">
                <i class="fa fa-times"></i>
            </button>
        </div>
    </div>

    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-table text-primary text-2xl"></i>
                <h1 class="text-xl font-bold text-primary">快捷Excel数据处理工具</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button id="privacyInfoBtn" class="text-neutral hover:text-primary transition-colors flex items-center">
                    <i class="fa fa-lock mr-1"></i> 隐私说明
                </button>
                <button id="helpBtn" class="text-neutral hover:text-primary transition-colors flex items-center">
                    <i class="fa fa-question-circle mr-1"></i> 帮助
                </button>
                <button id="helpBtn" class="text-neutral hover:text-primary transition-colors flex items-center" onclick="window.location.href='https://kexinnan2133.github.io/feedback.html'">
                    <i class="fa fa-question-circle mr-1"></i> 留言
                </button>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="container mx-auto px-4 py-6">
        <!-- 步骤指示器 -->
        <div class="flex flex-wrap justify-between items-center mb-8 bg-white p-4 rounded-lg shadow-sm">
            <div class="step-item flex items-center mb-2 md:mb-0" data-step="1">
                <div class="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center mr-2">1</div>
                <span class="font-medium">导入数据</span>
            </div>
            <div class="step-item flex items-center mb-2 md:mb-0" data-step="2">
                <div class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center mr-2">2</div>
                <span>数据清洗</span>
            </div>
            <div class="step-item flex items-center mb-2 md:mb-0" data-step="3">
                <div class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center mr-2">3</div>
                <span>条件计算</span>
            </div>
            <div class="step-item flex items-center" data-step="4">
                <div class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center mr-2">4</div>
                <span>导出结果</span>
            </div>
        </div>

        <!-- 功能区域 -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- 左侧功能菜单 -->
            <div class="lg:col-span-1 space-y-4">
                <!-- 功能卡片 -->
                <div class="bg-white rounded-lg shadow-sm overflow-hidden hover-scale">
                    <div class="p-4 border-b border-gray-100 bg-primary/5">
                        <h3 class="font-semibold text-primary flex items-center">
                            <i class="fa fa-upload mr-2"></i> 数据导入
                        </h3>
                    </div>
                    <div class="p-4">
                        <div id="uploadArea" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-primary transition-colors cursor-pointer">
                            <i class="fa fa-file-excel-o text-4xl text-neutral mb-2"></i>
                            <p class="text-sm text-neutral">拖放Excel或CSV文件到此处，或<span class="text-primary font-medium">点击上传</span></p>
                            <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" class="hidden">
                            <button id="manualInputBtn" class="mt-4 w-full py-2 bg-white border border-primary text-primary rounded hover:bg-primary/5 transition-colors text-sm">
                                手动输入数据
                            </button>
                        </div>
                        
                        <div id="worksheetSelector" class="mt-4 hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-1">选择工作表:</label>
                            <select id="worksheetSelect" class="w-full p-2 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary">
                                <!-- 由JS动态填充 -->
                            </select>
                        </div>

                        <!-- 标题行设置 -->
                        <div id="headerRowSettings" class="mt-4 hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-1">标题行设置:</label>
                            <div class="flex items-center space-x-2">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="headerRowOption" value="firstRow" class="form-radio text-primary" checked>
                                    <span class="ml-1 text-sm">第一行为标题</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="headerRowOption" value="noHeader" class="form-radio text-primary">
                                    <span class="ml-1 text-sm">无标题行</span>
                                </label>
                            </div>
                            <button id="applyHeaderSettings" class="mt-2 w-full py-1.5 bg-primary/10 text-primary rounded hover:bg-primary/20 transition-colors text-sm">
                                应用设置
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 数据清洗 -->
                <div class="bg-white rounded-lg shadow-sm overflow-hidden hover-scale">
                    <div class="p-4 border-b border-gray-100 bg-primary/5">
                        <h3 class="font-semibold text-primary flex items-center">
                            <i class="fa fa-filter mr-2"></i> 数据清洗
                        </h3>
                    </div>
                    <div class="p-4 space-y-3">
                        <!-- 新增：列类型设置 -->
                        <div>
                            <h4 class="text-sm font-medium mb-2">列类型设置</h4>
                            <div class="grid grid-cols-2 gap-2">
                                <select id="columnTypeSelect" class="py-1.5 px-2 text-sm border border-gray-200 rounded focus:ring-1 focus:ring-primary focus:border-primary">
                                    <option value="">-- 选择列 --</option>
                                    <!-- 由JS动态填充列名 -->
                                </select>
                                <div class="flex gap-1">
                                    <button id="forceNumberTypeBtn" class="flex-1 py-1.5 px-2 text-sm border border-gray-200 rounded hover:border-primary hover:text-primary transition-colors">
                                        <i class="fa fa-hashtag mr-1"></i> 数值
                                    </button>
                                    <button id="forceTextTypeBtn" class="flex-1 py-1.5 px-2 text-sm border border-gray-200 rounded hover:border-primary hover:text-primary transition-colors">
                                        <i class="fa fa-font mr-1"></i> 文本
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="text-sm font-medium mb-2">格式处理</h4>
                            <div class="grid grid-cols-2 gap-2">
                                <button class="clean-btn py-1.5 px-2 text-sm border border-gray-200 rounded hover:border-primary hover:text-primary transition-colors" data-action="date-standard">
                                    <i class="fa fa-calendar-o mr-1"></i> 日期标准化
                                </button>
                                <button class="clean-btn py-1.5 px-2 text-sm border border-gray-200 rounded hover:border-primary hover:text-primary transition-colors" data-action="text-case">
                                    <i class="fa fa-font mr-1"></i> 文本大小写
                                </button>
                                <button class="clean-btn py-1.5 px-2 text-sm border border-gray-200 rounded hover:border-primary hover:text-primary transition-colors" data-action="trim-spaces">
                                    <i class="fa fa-eraser mr-1"></i> 去除空格
                                </button>
                                <button class="clean-btn py-1.5 px-2 text-sm border border-gray-200 rounded hover:border-primary hover:text-primary transition-colors" data-action="remove-special">
                                    <i class="fa fa-ban mr-1"></i> 移除特殊字符
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="text-sm font-medium mb-2">缺失值处理</h4>
                            <div class="grid grid-cols-2 gap-2">
                                <button class="clean-btn py-1.5 px-2 text-sm border border-gray-200 rounded hover:border-primary hover:text-primary transition-colors" data-action="remove-na">
                                    <i class="fa fa-trash-o mr-1"></i> 删除缺失值
                                </button>
                                <button class="clean-btn py-1.5 px-2 text-sm border border-gray-200 rounded hover:border-primary hover:text-primary transition-colors" data-action="fill-mean">
                                    <i class="fa fa-calculator mr-1"></i> 均值填充
                                </button>
                                <button class="clean-btn py-1.5 px-2 text-sm border border-gray-200 rounded hover:border-primary hover:text-primary transition-colors" data-action="fill-median">
                                    <i class="fa fa-signal mr-1"></i> 中位数填充
                                </button>
                                <button class="clean-btn py-1.5 px-2 text-sm border border-gray-200 rounded hover:border-primary hover:text-primary transition-colors" data-action="fill-custom">
                                    <i class="fa fa-pencil mr-1"></i> 自定义填充
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="text-sm font-medium mb-2">其他处理</h4>
                            <div class="grid grid-cols-2 gap-2">
                                <button class="clean-btn py-1.5 px-2 text-sm border border-gray-200 rounded hover:border-primary hover:text-primary transition-colors" data-action="remove-duplicates">
                                    <i class="fa fa-copy mr-1"></i> 去除重复值
                                </button>
                                <button class="clean-btn py-1.5 px-2 text-sm border border-gray-200 rounded hover:border-primary hover:text-primary transition-colors" data-action="detect-outliers">
                                    <i class="fa fa-exclamation-triangle mr-1"></i> 检测异常值
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 条件计算 -->
                <div class="bg-white rounded-lg shadow-sm overflow-hidden hover-scale">
                    <div class="p-4 border-b border-gray-100 bg-primary/5">
                        <h3 class="font-semibold text-primary flex items-center">
                            <i class="fa fa-calculator mr-2"></i> 条件计算
                        </h3>
                    </div>
                    <div class="p-4 space-y-3">
                        <div>
                            <h4 class="text-sm font-medium mb-2">基础条件函数</h4>
                            <div class="space-y-1.5">
                                <button class="calc-btn w-full py-1.5 px-2 text-sm border border-gray-200 rounded text-left hover:border-primary hover:text-primary transition-colors" data-function="if">
                                    <i class="fa fa-code-fork mr-2"></i> IF(条件,值1,值2)
                                </button>
                                <button class="calc-btn w-full py-1.5 px-2 text-sm border border-gray-200 rounded text-left hover:border-primary hover:text-primary transition-colors" data-function="countif">
                                    <i class="fa fa-hashtag mr-2"></i> COUNTIF(范围,条件)
                                </button>
                                <button class="calc-btn w-full py-1.5 px-2 text-sm border border-gray-200 rounded text-left hover:border-primary hover:text-primary transition-colors" data-function="sumif">
                                    <i class="fa fa-plus-square mr-2"></i> SUMIF(范围,条件,求和范围)
                                </button>
                                <button class="calc-btn w-full py-1.5 px-2 text-sm border border-gray-200 rounded text-left hover:border-primary hover:text-primary transition-colors" data-function="averageif">
                                    <i class="fa fa-line-chart mr-2"></i> AVERAGEIF(范围,条件,平均范围)
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="text-sm font-medium mb-2">多条件函数</h4>
                            <div class="space-y-1.5">
                                <button class="calc-btn w-full py-1.5 px-2 text-sm border border-gray-200 rounded text-left hover:border-primary hover:text-primary transition-colors" data-function="ifs">
                                    <i class="fa fa-sitemap mr-2"></i> IFS(条件1,值1,条件2,值2...)
                                </button>
                                <button class="calc-btn w-full py-1.5 px-2 text-sm border border-gray-200 rounded text-left hover:border-primary hover:text-primary transition-colors" data-function="countifs">
                                    <i class="fa fa-list-ol mr-2"></i> COUNTIFS(范围1,条件1,范围2,条件2...)
                                </button>
                                <button class="calc-btn w-full py-1.5 px-2 text-sm border border-gray-200 rounded text-left hover:border-primary hover:text-primary transition-colors" data-function="sumifs">
                                    <i class="fa fa-cubes mr-2"></i> SUMIFS(求和范围,范围1,条件1...)
                                </button>
                                <button class="calc-btn w-full py-1.5 px-2 text-sm border border-gray-200 rounded text-left hover:border-primary hover:text-primary transition-colors" data-function="averageifs">
                                    <i class="fa fa-area-chart mr-2"></i> AVERAGEIFS(平均范围,范围1,条件1...)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 导出分享 -->
                <div class="bg-white rounded-lg shadow-sm overflow-hidden hover-scale">
                    <div class="p-4 border-b border-gray-100 bg-primary/5">
                        <h3 class="font-semibold text-primary flex items-center">
                            <i class="fa fa-download mr-2"></i> 导出结果
                        </h3>
                    </div>
                    <div class="p-4 space-y-3">
                        <button id="exportExcelBtn" class="w-full py-2 bg-white border border-primary text-primary rounded hover:bg-primary/5 transition-colors flex items-center justify-center">
                            <i class="fa fa-file-excel-o mr-2"></i> 导出为Excel
                        </button>
                        <button id="exportCsvBtn" class="w-full py-2 bg-white border border-primary text-primary rounded hover:bg-primary/5 transition-colors flex items-center justify-center">
                            <i class="fa fa-file-text-o mr-2"></i> 导出为CSV
                        </button>
                        <button id="clearDataBtn" class="w-full py-2 bg-white border border-danger text-danger rounded hover:bg-danger/5 transition-colors flex items-center justify-center mt-4">
                            <i class="fa fa-trash mr-2"></i> 清除所有数据
                        </button>
                    </div>
                </div>
            </div>

            <!-- 右侧数据展示和操作区 -->
            <div class="lg:col-span-3 space-y-6">
                <!-- 数据预览区 -->
                <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                        <h3 class="font-semibold text-gray-800 flex items-center">
                            <i class="fa fa-table mr-2"></i> 数据预览
                        </h3>
                        <div class="flex items-center space-x-2">
                            <div class="text-sm text-gray-500">
                                <span id="rowCount">0</span> 行 | <span id="colCount">0</span> 列
                            </div>
                            <button id="refreshTableBtn" class="text-neutral hover:text-primary transition-colors">
                                <i class="fa fa-refresh"></i>
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto max-h-[500px]">
                        <table id="dataTable" class="w-full table-shadow">
                            <thead>
                                <tr class="bg-gray-50">
                                    <!-- 由JS动态填充 -->
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 由JS动态填充 -->
                            </tbody>
                        </table>
                    </div>
                    <div class="p-4 border-t border-gray-100 text-sm text-gray-500 flex justify-between">
                        <div>显示前 <span id="displayedRows">0</span> 行数据</div>
                        <div>
                            <button id="showMoreBtn" class="text-primary hover:underline" disabled>显示更多</button>
                        </div>
                    </div>
                </div>

                <!-- 函数配置面板 -->
                <div id="functionPanel" class="bg-white rounded-lg shadow-sm overflow-hidden hidden">
                    <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                        <h3 id="functionPanelTitle" class="font-semibold text-gray-800">函数配置</h3>
                        <button id="closeFunctionPanel" class="text-neutral hover:text-danger transition-colors">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                    <div class="p-4">
                        <div id="functionDescription" class="mb-4 text-sm text-gray-600 p-3 bg-gray-50 rounded">
                            <!-- 函数描述由JS动态填充 -->
                        </div>
                        
                        <form id="functionForm" class="space-y-4">
                            <input type="hidden" id="functionType" value="">
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">结果列名称</label>
                                <input type="text" id="resultColumnName" class="w-full p-2 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary" placeholder="输入新列名称">
                            </div>
                            
                            <div id="functionParameters">
                                <!-- 函数参数由JS动态生成 -->
                            </div>
                            
                            <div class="pt-2">
                                <button type="submit" class="py-2 px-4 bg-primary text-white rounded hover:bg-primary/90 transition-colors">
                                    应用计算
                                </button>
                                <button type="button" id="previewCalculationBtn" class="ml-2 py-2 px-4 bg-white border border-primary text-primary rounded hover:bg-primary/5 transition-colors">
                                    预览结果
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- 多维度分析框架 -->
                <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <div class="p-4 border-b border-gray-100">
                        <h3 class="font-semibold text-gray-800 flex items-center">
                            <i class="fa fa-cubes mr-2"></i> 多维度分析
                        </h3>
                    </div>
                    <div class="p-4">
                        <!-- 维度配置区 -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <!-- 可用字段 -->
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="font-medium text-sm text-gray-700">可用字段</h4>
                                    <button id="clearAllDimensions" class="text-xs text-neutral hover:text-danger">
                                        <i class="fa fa-refresh mr-1"></i> 重置
                                    </button>
                                </div>
                                <div id="availableFields" class="dimension-area p-3 border border-gray-200 rounded-lg bg-gray-50">
                                    <div class="text-sm text-gray-500 italic" id="noAvailableFieldsMsg">
                                        请先导入数据
                                    </div>
                                    <!-- 可用字段由JS动态生成 -->
                                </div>
                            </div>
                            
                            <!-- 行维度 -->
                            <div>
                                <h4 class="font-medium text-sm text-gray-700 mb-2">行维度</h4>
                                <div id="rowDimensions" class="dimension-area p-3 border border-gray-200 rounded-lg bg-gray-50" ondragover="event.preventDefault()" ondrop="dropField(event, 'row')" onmouseenter="highlightDimensionArea('row', true)" onmouseleave="highlightDimensionArea('row', false)">
                                    <div class="text-sm text-gray-500 italic">
                                        拖拽字段到此处
                                    </div>
                                    <!-- 行维度字段由JS动态生成 -->
                                </div>
                            </div>
                            
                            <!-- 值维度 -->
                            <div>
                                <h4 class="font-medium text-sm text-gray-700 mb-2">值维度</h4>
                                <div id="valueDimensions" class="dimension-area p-3 border border-gray-200 rounded-lg bg-gray-50" ondragover="event.preventDefault()" ondrop="dropField(event, 'value')" onmouseenter="highlightDimensionArea('value', true)" onmouseleave="highlightDimensionArea('value', false)">
                                    <div class="text-sm text-gray-500 italic">
                                        拖拽数值字段到此处
                                    </div>
                                    <!-- 值维度字段由JS动态生成 -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- 聚合方式选择 -->
                        <div class="mb-6">
                            <h4 class="font-medium text-sm text-gray-700 mb-2">聚合方式</h4>
                            <div class="flex flex-wrap gap-2">
                                <button class="aggregation-btn py-1 px-3 bg-primary text-white rounded text-sm" data-aggregation="sum">
                                    求和
                                </button>
                                <button class="aggregation-btn py-1 px-3 bg-white border border-gray-200 rounded text-sm hover:border-primary hover:text-primary transition-colors" data-aggregation="average">
                                    平均值
                                </button>
                                <button class="aggregation-btn py-1 px-3 bg-white border border-gray-200 rounded text-sm hover:border-primary hover:text-primary transition-colors" data-aggregation="count">
                                    计数
                                </button>
                                <button class="aggregation-btn py-1 px-3 bg-white border border-gray-200 rounded text-sm hover:border-primary hover:text-primary transition-colors" data-aggregation="max">
                                    最大值
                                </button>
                                <button class="aggregation-btn py-1 px-3 bg-white border border-gray-200 rounded text-sm hover:border-primary hover:text-primary transition-colors" data-aggregation="min">
                                    最小值
                                </button>
                            </div>
                        </div>
                        
                        <!-- 图表设置 -->
                        <div class="mb-6">
                            <div class="flex flex-wrap justify-between items-center mb-4">
                                <h4 class="font-medium text-sm text-gray-700">图表展示</h4>
                                <button id="exportChartBtn" class="py-1 px-3 bg-white border border-primary text-primary rounded text-sm hover:bg-primary/5 transition-colors flex items-center" disabled>
                                    <i class="fa fa-download mr-1"></i> 导出图表
                                </button>
                            </div>
                            
                            <div class="flex flex-wrap gap-2 mb-4">
                                <select id="pivotChartTypeSelect" class="p-2 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary">
                                    <option value="bar">柱状图</option>
                                    <option value="pie">饼图</option>
                                    <option value="line">折线图</option>
                                    <option value="doughnut">环形图</option>
                                    <option value="polarArea">极坐标图</option>
                                    <option value="radar">雷达图</option>
                                </select>
                                <button id="refreshChartBtn" class="py-2 px-4 bg-primary text-white rounded hover:bg-primary/90 transition-colors" disabled>
                                    刷新图表
                                </button>
                            </div>
                            
                            <div class="h-[300px] relative">
                                <canvas id="pivotChart"></canvas>
                                <div id="chartPlaceholder" class="absolute inset-0 flex items-center justify-center text-gray-400">
                                    <div class="text-center">
                                        <i class="fa fa-bar-chart text-4xl mb-2"></i>
                                        <p>配置维度后显示图表</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 透视表预览 -->
                        <div>
                            <h4 class="font-medium text-sm text-gray-700 mb-2">透视表数据</h4>
                            <div class="overflow-x-auto max-h-[300px] border border-gray-200 rounded-lg">
                                <table id="pivotTable" class="w-full table-shadow">
                                    <thead>
                                        <tr class="bg-gray-50">
                                            <!-- 由JS动态填充 -->
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="100%" class="text-center py-8 text-gray-400">
                                                配置维度后显示透视表数据
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 数据统计和可视化 -->
                <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <div class="p-4 border-b border-gray-100">
                        <h3 class="font-semibold text-gray-800 flex items-center">
                            <i class="fa fa-bar-chart mr-2"></i> 数据统计
                        </h3>
                    </div>
                    <div class="p-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="p-3 border border-gray-100 rounded-lg bg-gray-50">
                                <div class="text-sm text-gray-500">数值列平均值</div>
                                <div id="avgValue" class="text-xl font-semibold text-primary">-</div>
                            </div>
                            <div class="p-3 border border-gray-100 rounded-lg bg-gray-50">
                                <div class="text-sm text-gray-500">总行数</div>
                                <div id="totalRows" class="text-xl font-semibold text-primary">0</div>
                            </div>
                            <div class="p-3 border border-gray-100 rounded-lg bg-gray-50">
                                <div class="text-sm text-gray-500">处理步骤</div>
                                <div id="processSteps" class="text-xl font-semibold text-primary">0</div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">选择列进行可视化</label>
                            <div class="flex flex-wrap gap-2 mb-4">
                                <select id="chartColumnSelect" class="p-2 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary">
                                    <option value="">-- 选择列 --</option>
                                    <!-- 由JS动态填充 -->
                                </select>
                                <select id="chartTypeSelect" class="p-2 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary">
                                    <option value="bar">柱状图</option>
                                    <option value="pie">饼图</option>
                                    <option value="line">折线图</option>
                                </select>
                                <button id="generateChartBtn" class="py-2 px-4 bg-primary text-white rounded hover:bg-primary/90 transition-colors" disabled>
                                    生成图表
                                </button>
                            </div>
                            <div class="h-[300px]">
                                <canvas id="dataChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 操作日志 -->
                <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <div class="p-4 border-b border-gray-100">
                        <h3 class="font-semibold text-gray-800 flex items-center">
                            <i class="fa fa-history mr-2"></i> 操作日志
                        </h3>
                    </div>
                    <div id="operationLog" class="p-4 max-h-[200px] overflow-y-auto text-sm space-y-2">
                        <div class="text-gray-500 italic">操作记录将显示在这里...</div>
                        <!-- 由JS动态填充 -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 隐私说明模态框 -->
    <div id="privacyInfoModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                <h3 class="font-semibold text-lg">隐私保护说明</h3>
                <button id="closePrivacyInfoModal" class="text-neutral hover:text-danger transition-colors">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex items-start">
                    <i class="fa fa-shield text-success text-xl mt-1 mr-3"></i>
                    <div>
                        <h4 class="font-medium text-primary mb-1">数据处理方式</h4>
                        <p class="text-sm text-gray-600">您上传的所有数据仅在本地浏览器中处理，不会上传至任何服务器或第三方服务。所有操作均在您的设备上完成。</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 帮助模态框 -->
    <div id="helpModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                <h3 class="font-semibold text-lg">使用帮助</h3>
                <button id="closeHelpModal" class="text-neutral hover:text-danger transition-colors">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <h4 class="font-medium text-primary mb-2">如何开始使用？</h4>
                    <p class="text-sm text-gray-600">1. 上传Excel或CSV文件，或手动输入数据</p>
                    <p class="text-sm text-gray-600">2. 进行必要的数据清洗操作</p>
                    <p class="text-sm text-gray-600">3. 使用条件计算功能进行数据处理</p>
                    <p class="text-sm text-gray-600">4. 通过拖拽字段进行多维度分析</p>
                    <p class="text-sm text-gray-600">5. 导出处理后的结果</p>
                </div>
                
                <div>
                    <h4 class="font-medium text-primary mb-2">列类型设置</h4>
                    <p class="text-sm text-gray-600">如果系统误判了列类型，您可以在"数据清洗"区域手动设置列类型：</p>
                    <p class="text-sm text-gray-600">1. 在下拉菜单中选择需要修改类型的列</p>
                    <p class="text-sm text-gray-600">2. 点击"数值"或"文本"按钮强制设置列类型</p>
                    <p class="text-sm text-gray-600">3. 重新尝试将列拖放到值维度</p>
                </div>
                
                <div>
                    <h4 class="font-medium text-primary mb-2">多维度分析使用说明</h4>
                    <p class="text-sm text-gray-600">1. 从可用字段中拖拽字段到行维度或值维度</p>
                    <p class="text-sm text-gray-600">2. 选择合适的聚合方式（求和、平均值等）</p>
                    <p class="text-sm text-gray-600">3. 选择图表类型并点击刷新图表查看可视化结果</p>
                    <p class="text-sm text-gray-600">4. 可将图表导出为PNG图片保存</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 自定义填充模态框 -->
    <div id="customFillModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-lg max-w-md w-full">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                <h3 class="font-semibold">自定义填充缺失值</h3>
                <button id="closeCustomFillModal" class="text-neutral hover:text-danger transition-colors">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">选择列</label>
                    <select id="fillColumnSelect" class="w-full p-2 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary">
                        <!-- 由JS动态填充 -->
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">填充值</label>
                    <input type="text" id="fillValueInput" class="w-full p-2 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary" placeholder="输入填充值">
                </div>
                
                <div class="pt-2 flex justify-end">
                    <button id="applyFillBtn" class="py-2 px-4 bg-primary text-white rounded hover:bg-primary/90 transition-colors">
                        应用填充
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 手动输入数据模态框 -->
    <div id="manualInputModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                <h3 class="font-semibold">手动输入数据</h3>
                <button id="closeManualInputModal" class="text-neutral hover:text-danger transition-colors">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">列名（用逗号分隔）</label>
                    <input type="text" id="columnNamesInput" class="w-full p-2 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary" placeholder="例如：姓名,年龄,性别,成绩">
                </div>
                
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-medium text-gray-700">数据行</label>
                        <div>
                            <button id="addRowBtn" class="py-1 px-2 bg-primary/10 text-primary rounded hover:bg-primary/20 transition-colors text-sm">
                                <i class="fa fa-plus mr-1"></i> 添加行
                            </button>
                            <button id="removeRowBtn" class="py-1 px-2 bg-gray-100 text-gray-600 rounded hover:bg-gray-200 transition-colors text-sm ml-1">
                                <i class="fa fa-minus mr-1"></i> 删除行
                            </button>
                        </div>
                    </div>
                    
                    <div id="manualDataRows" class="space-y-2">
                        <div class="flex items-center">
                            <input type="text" class="manual-row-input w-full p-2 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary" placeholder="用逗号分隔一行数据">
                        </div>
                        <div class="flex items-center">
                            <input type="text" class="manual-row-input w-full p-2 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary" placeholder="用逗号分隔一行数据">
                        </div>
                    </div>
                </div>
                
                <div class="pt-2 flex justify-end">
                    <button id="applyManualDataBtn" class="py-2 px-4 bg-primary text-white rounded hover:bg-primary/90 transition-colors">
                        应用数据
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 数据清理确认模态框 -->
    <div id="clearDataConfirmModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-lg max-w-md w-full">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                <h3 class="font-semibold">确认清除数据</h3>
                <button id="closeClearDataModal" class="text-neutral hover:text-danger transition-colors">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex items-start">
                    <i class="fa fa-exclamation-circle text-warning text-xl mt-1 mr-3"></i>
                    <p class="text-sm text-gray-600">此操作将清除当前所有数据和操作记录，且无法恢复。请确保您已导出所需结果。</p>
                </div>
                
                <div class="pt-2 flex justify-end">
                    <button id="cancelClearDataBtn" class="py-2 px-4 bg-white border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition-colors mr-2">
                        取消
                    </button>
                    <button id="confirmClearDataBtn" class="py-2 px-4 bg-danger text-white rounded hover:bg-danger/90 transition-colors">
                        确认清除
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 通知提示 -->
    <div id="notification" class="fixed bottom-4 right-4 p-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50 max-w-sm">
        <div class="flex items-start">
            <div id="notificationIcon" class="mr-3 text-xl"></div>
            <div>
                <h4 id="notificationTitle" class="font-medium"></h4>
                <p id="notificationMessage" class="text-sm mt-1"></p>
            </div>
            <button id="closeNotification" class="ml-auto text-gray-400 hover:text-gray-600">
                <i class="fa fa-times"></i>
            </button>
        </div>
    </div>

    <script>
        // 全局变量
        let originalData = []; // 原始数据
        let currentData = []; // 当前处理的数据
        let columns = []; // 列名
        let columnTypes = {}; // 列类型
        let maxDisplayRows = 50; // 最大显示行数
        let operationHistory = []; // 操作历史
        let workbook = null; // Excel工作簿
        let currentWorksheet = ''; // 当前工作表
        let chartInstance = null; // 图表实例
        let useFirstRowAsHeader = true; // 是否将第一行作为标题行
        let processStepCount = 0; // 处理步骤计数
        let pivotChartInstance = null; // 透视图表实例
        let pivotData = []; // 透视表数据
        let pivotColumns = []; // 透视表列名
        let pivotRows = []; // 透视表行数据
        let pivotChartType = 'bar'; // 透视图表类型，默认柱状图

        // 多维度分析相关变量
        let rowDimensions = []; // 行维度
        let valueDimensions = []; // 值维度
        let availableFieldsList = []; // 可用字段列表
        let currentAggregation = 'sum'; // 聚合方式，默认求和

        // DOM元素
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const dataTable = document.getElementById('dataTable');
        const rowCount = document.getElementById('rowCount');
        const colCount = document.getElementById('colCount');
        const displayedRows = document.getElementById('displayedRows');
        const showMoreBtn = document.getElementById('showMoreBtn');
        const worksheetSelector = document.getElementById('worksheetSelector');
        const worksheetSelect = document.getElementById('worksheetSelect');
        const headerRowSettings = document.getElementById('headerRowSettings');
        const applyHeaderSettings = document.getElementById('applyHeaderSettings');
        const functionPanel = document.getElementById('functionPanel');
        const closeFunctionPanel = document.getElementById('closeFunctionPanel');
        const functionForm = document.getElementById('functionForm');
        const functionPanelTitle = document.getElementById('functionPanelTitle');
        const functionDescription = document.getElementById('functionDescription');
        const functionParameters = document.getElementById('functionParameters');
        const functionType = document.getElementById('functionType');
        const resultColumnName = document.getElementById('resultColumnName');
        const previewCalculationBtn = document.getElementById('previewCalculationBtn');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const clearDataBtn = document.getElementById('clearDataBtn');
        const operationLog = document.getElementById('operationLog');
        const helpBtn = document.getElementById('helpBtn');
        const helpModal = document.getElementById('helpModal');
        const closeHelpModal = document.getElementById('closeHelpModal');
        const privacyInfoBtn = document.getElementById('privacyInfoBtn');
        const privacyInfoModal = document.getElementById('privacyInfoModal');
        const closePrivacyInfoModal = document.getElementById('closePrivacyInfoModal');
        const hidePrivacyBar = document.getElementById('hidePrivacyBar');
        const customFillModal = document.getElementById('customFillModal');
        const closeCustomFillModal = document.getElementById('closeCustomFillModal');
        const fillColumnSelect = document.getElementById('fillColumnSelect');
        const fillValueInput = document.getElementById('fillValueInput');
        const applyFillBtn = document.getElementById('applyFillBtn');
        const manualInputBtn = document.getElementById('manualInputBtn');
        const manualInputModal = document.getElementById('manualInputModal');
        const closeManualInputModal = document.getElementById('closeManualInputModal');
        const columnNamesInput = document.getElementById('columnNamesInput');
        const manualDataRows = document.getElementById('manualDataRows');
        const addRowBtn = document.getElementById('addRowBtn');
        const removeRowBtn = document.getElementById('removeRowBtn');
        const applyManualDataBtn = document.getElementById('applyManualDataBtn');
        const notification = document.getElementById('notification');
        const notificationIcon = document.getElementById('notificationIcon');
        const notificationTitle = document.getElementById('notificationTitle');
        const notificationMessage = document.getElementById('notificationMessage');
        const closeNotification = document.getElementById('closeNotification');
        const chartColumnSelect = document.getElementById('chartColumnSelect');
        const chartTypeSelect = document.getElementById('chartTypeSelect');
        const generateChartBtn = document.getElementById('generateChartBtn');
        const dataChart = document.getElementById('dataChart');
        const avgValue = document.getElementById('avgValue');
        const totalRows = document.getElementById('totalRows');
        const processSteps = document.getElementById('processSteps');
        const refreshTableBtn = document.getElementById('refreshTableBtn');
        const clearDataConfirmModal = document.getElementById('clearDataConfirmModal');
        const closeClearDataModal = document.getElementById('closeClearDataModal');
        const cancelClearDataBtn = document.getElementById('cancelClearDataBtn');
        const confirmClearDataBtn = document.getElementById('confirmClearDataBtn');
        const hideImportFormatBar = document.getElementById('hideImportFormatBar');

        // 新增：列类型设置相关元素
        const columnTypeSelect = document.getElementById('columnTypeSelect');
        const forceNumberTypeBtn = document.getElementById('forceNumberTypeBtn');
        const forceTextTypeBtn = document.getElementById('forceTextTypeBtn');

        // 多维度分析DOM元素
        const availableFields = document.getElementById('availableFields');
        const rowDimensionsContainer = document.getElementById('rowDimensions');
        const valueDimensionsContainer = document.getElementById('valueDimensions');
        const pivotTable = document.getElementById('pivotTable');
        const pivotChart = document.getElementById('pivotChart');
        const chartPlaceholder = document.getElementById('chartPlaceholder');
        const refreshChartBtn = document.getElementById('refreshChartBtn');
        const pivotChartTypeSelect = document.getElementById('pivotChartTypeSelect');
        const exportChartBtn = document.getElementById('exportChartBtn');
        const clearAllDimensions = document.getElementById('clearAllDimensions');
        const aggregationBtns = document.querySelectorAll('.aggregation-btn');
        const noAvailableFieldsMsg = document.getElementById('noAvailableFieldsMsg');

        // 初始化
        function init() {
            setupEventListeners();
            updateStepIndicator(1);
            logOperation("工具已启动，所有数据仅在本地处理");
        }

        // 页面加载后初始化
        window.onload = init;

        // 设置事件监听器
        function setupEventListeners() {
            // 标题行设置
            applyHeaderSettings.addEventListener('click', function() {
                const useHeader = document.querySelector('input[name="headerRowOption"][value="firstRow"]').checked;
                if (useHeader !== useFirstRowAsHeader) {
                    useFirstRowAsHeader = useHeader;
                    if (currentWorksheet) {
                        loadWorksheetData(currentWorksheet);
                        showNotification('成功', useHeader ? '已设置第一行为标题' : '已设置无标题行', 'success');
                    }
                }
            });
            
            // 列类型设置事件
            forceNumberTypeBtn.addEventListener('click', function() {
                const col = columnTypeSelect.value;
                if (col) {
                    columnTypes[col] = 'number';
                    updateColumnTypeSelect();
                    renderAvailableFields();
                    showNotification('成功', `已将"${col}"强制设为数值类型`, 'success');
                    logOperation(`将"${col}"强制设为数值类型`);
                } else {
                    showNotification('提示', '请先选择一列', 'info');
                }
            });
            
            forceTextTypeBtn.addEventListener('click', function() {
                const col = columnTypeSelect.value;
                if (col) {
                    columnTypes[col] = 'text';
                    updateColumnTypeSelect();
                    renderAvailableFields();
                    showNotification('成功', `已将"${col}"强制设为文本类型`, 'success');
                    logOperation(`将"${col}"强制设为文本类型`);
                } else {
                    showNotification('提示', '请先选择一列', 'info');
                }
            });
            
            // 隐私相关
            privacyInfoBtn.addEventListener('click', () => privacyInfoModal.classList.remove('hidden'));
            closePrivacyInfoModal.addEventListener('click', () => privacyInfoModal.classList.add('hidden'));
            
            // 提示条关闭
            hidePrivacyBar.addEventListener('click', () => {
                document.getElementById('privacyBar').style.display = 'none';
            });
            hideImportFormatBar.addEventListener('click', () => {
                document.getElementById('importFormatBar').style.display = 'none';
            });
            
            // 数据清除相关
            clearDataBtn.addEventListener('click', () => {
                if (currentData.length > 0 || operationHistory.length > 0) {
                    clearDataConfirmModal.classList.remove('hidden');
                } else {
                    showNotification('信息', '没有可清除的数据', 'info');
                }
            });
            closeClearDataModal.addEventListener('click', () => clearDataConfirmModal.classList.add('hidden'));
            cancelClearDataBtn.addEventListener('click', () => clearDataConfirmModal.classList.add('hidden'));
            confirmClearDataBtn.addEventListener('click', () => {
                clearAllData();
                clearDataConfirmModal.classList.add('hidden');
                showNotification('成功', '所有数据已清除', 'success');
            });
            
            // 文件上传相关
            uploadArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileUpload);
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('drop', handleDrop);
            worksheetSelect.addEventListener('change', handleWorksheetChange);
            
            // 数据清洗按钮
            document.querySelectorAll('.clean-btn').forEach(btn => {
                btn.addEventListener('click', handleCleanAction);
            });
            
            // 计算函数按钮
            document.querySelectorAll('.calc-btn').forEach(btn => {
                btn.addEventListener('click', handleCalcFunction);
            });
            
            // 函数面板相关
            closeFunctionPanel.addEventListener('click', () => functionPanel.classList.add('hidden'));
            functionForm.addEventListener('submit', handleFunctionSubmit);
            previewCalculationBtn.addEventListener('click', handlePreviewCalculation);
            
            // 导出按钮
            exportExcelBtn.addEventListener('click', exportToExcel);
            exportCsvBtn.addEventListener('click', exportToCsv);
            
            // 帮助模态框
            helpBtn.addEventListener('click', () => helpModal.classList.remove('hidden'));
            closeHelpModal.addEventListener('click', () => helpModal.classList.add('hidden'));
            
            // 自定义填充模态框
            document.querySelector('.clean-btn[data-action="fill-custom"]').addEventListener('click', () => {
                if (columns.length === 0) {
                    showNotification('错误', '请先导入数据', 'error');
                    return;
                }
                populateFillColumnSelect();
                customFillModal.classList.remove('hidden');
            });
            closeCustomFillModal.addEventListener('click', () => customFillModal.classList.add('hidden'));
            applyFillBtn.addEventListener('click', applyCustomFill);
            
            // 手动输入数据模态框
            manualInputBtn.addEventListener('click', () => manualInputModal.classList.remove('hidden'));
            closeManualInputModal.addEventListener('click', () => manualInputModal.classList.add('hidden'));
            addRowBtn.addEventListener('click', addManualDataRow);
            removeRowBtn.addEventListener('click', removeManualDataRow);
            applyManualDataBtn.addEventListener('click', applyManualData);
            
            // 通知关闭按钮
            closeNotification.addEventListener('click', hideNotification);
            
            // 图表生成
            chartColumnSelect.addEventListener('change', () => {
                generateChartBtn.disabled = !chartColumnSelect.value;
            });
            generateChartBtn.addEventListener('click', generateChart);
            
            // 显示更多数据
            showMoreBtn.addEventListener('click', () => {
                maxDisplayRows += 50;
                renderTable();
            });
            
            // 刷新表格
            refreshTableBtn.addEventListener('click', renderTable);
            
            // 多维度分析相关事件监听
            initDimensionEventListeners();
        }

        // 初始化维度分析相关事件
        function initDimensionEventListeners() {
            // 聚合方式选择
            aggregationBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    aggregationBtns.forEach(b => {
                        b.classList.remove('bg-primary', 'text-white');
                        b.classList.add('bg-white', 'border', 'border-gray-200', 'hover:border-primary', 'hover:text-primary');
                    });
                    this.classList.remove('bg-white', 'border', 'border-gray-200', 'hover:border-primary', 'hover:text-primary');
                    this.classList.add('bg-primary', 'text-white');
                    currentAggregation = this.dataset.aggregation;
                    if (rowDimensions.length > 0 && valueDimensions.length > 0) {
                        updatePivotAnalysis();
                    }
                });
            });
            
            // 刷新图表按钮
            refreshChartBtn.addEventListener('click', updatePivotAnalysis);
            
            // 清除所有维度
            clearAllDimensions.addEventListener('click', clearDimensions);
            
            // 导出图表
            exportChartBtn.addEventListener('click', exportChartAsPNG);
            
            // 图表类型切换
            pivotChartTypeSelect.addEventListener('change', function() {
                pivotChartType = this.value;
                if (rowDimensions.length > 0 && valueDimensions.length > 0) {
                    updatePivotAnalysis();
                }
            });
        }

        // 更新列类型选择器
        function updateColumnTypeSelect() {
            const currentValue = columnTypeSelect.value;
            columnTypeSelect.innerHTML = '';
            
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '-- 选择列 --';
            columnTypeSelect.appendChild(defaultOption);
            
            columns.forEach(col => {
                const option = document.createElement('option');
                option.value = col;
                option.textContent = `${col} (当前: ${getTypeDisplayName(columnTypes[col])})`;
                columnTypeSelect.appendChild(option);
            });
            
            // 保持之前的选择
            if (currentValue && columns.includes(currentValue)) {
                columnTypeSelect.value = currentValue;
            }
        }
        
        // 获取类型的显示名称
        function getTypeDisplayName(type) {
            const typeNames = {
                'number': '数值',
                'text': '文本',
                'date': '日期'
            };
            return typeNames[type] || '未知';
        }

        // 清除所有数据
        function clearAllData() {
            originalData = [];
            currentData = [];
            columns = [];
            columnTypes = {};
            operationHistory = [];
            workbook = null;
            currentWorksheet = '';
            maxDisplayRows = 50;
            useFirstRowAsHeader = true;
            rowDimensions = [];
            valueDimensions = [];
            
            // 重置UI
            renderTable();
            updateStatistics();
            populateChartColumnSelect();
            worksheetSelector.classList.add('hidden');
            headerRowSettings.classList.add('hidden');
            functionPanel.classList.add('hidden');
            operationLog.innerHTML = '<div class="text-gray-500 italic">操作记录将显示在这里...</div>';
            updateStepIndicator(1);
            renderAvailableFields();
            renderDimensions();
            updateColumnTypeSelect();
            
            // 清除图表
            if (chartInstance) {
                chartInstance.destroy();
                chartInstance = null;
            }
            if (pivotChartInstance) {
                pivotChartInstance.destroy();
                pivotChartInstance = null;
            }
            
            logOperation("所有数据已清除");
        }

        // 处理文件上传
        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) {
                showNotification('错误', '未选择文件', 'error');
                return;
            }
            // 文件类型校验
            const fileExtension = file.name.split('.').pop().toLowerCase();
            if (!['xlsx', 'xls', 'csv'].includes(fileExtension)) {
                showNotification('错误', '请上传Excel或CSV文件', 'error');
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    workbook = XLSX.read(data, { type: 'array' });
                    if (!workbook || !workbook.SheetNames || workbook.SheetNames.length === 0) {
                        showNotification('错误', '未检测到有效工作表，请检查文件内容', 'error');
                        return;
                    }
                    // 显示工作表选择器和标题行设置
                    populateWorksheetSelector();
                    worksheetSelector.classList.remove('hidden');
                    headerRowSettings.classList.remove('hidden');
                    // 默认选择第一个工作表
                    currentWorksheet = workbook.SheetNames[0];
                    worksheetSelect.value = currentWorksheet;
                    // 加载数据
                    loadWorksheetData(currentWorksheet);
                    // 数据内容校验
                    if (columns.length === 0 || currentData.length === 0) {
                        showNotification('警告', '导入数据为空或格式不正确，请检查表头和数据内容', 'warning');
                        return;
                    }
                    showNotification('成功', `已导入文件: ${file.name}`, 'success');
                    logOperation(`导入文件: ${file.name}`);
                    updateStepIndicator(2);
                } catch (error) {
                    console.error('文件解析错误:', error);
                    showNotification('错误', '文件解析失败，请检查文件格式', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // 处理拖放上传
        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('border-primary');
            uploadArea.classList.add('bg-primary/5');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('border-primary');
            uploadArea.classList.remove('bg-primary/5');
            const file = e.dataTransfer.files[0];
            if (!file) {
                showNotification('错误', '未选择文件', 'error');
                return;
            }
            // 文件类型校验
            const fileExtension = file.name.split('.').pop().toLowerCase();
            if (!['xlsx', 'xls', 'csv'].includes(fileExtension)) {
                showNotification('错误', '请上传Excel或CSV文件', 'error');
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    workbook = XLSX.read(data, { type: 'array' });
                    if (!workbook || !workbook.SheetNames || workbook.SheetNames.length === 0) {
                        showNotification('错误', '未检测到有效工作表，请检查文件内容', 'error');
                        return;
                    }
                    // 显示工作表选择器和标题行设置
                    populateWorksheetSelector();
                    worksheetSelector.classList.remove('hidden');
                    headerRowSettings.classList.remove('hidden');
                    // 默认选择第一个工作表
                    currentWorksheet = workbook.SheetNames[0];
                    worksheetSelect.value = currentWorksheet;
                    // 加载数据
                    loadWorksheetData(currentWorksheet);
                    // 数据内容校验
                    if (columns.length === 0 || currentData.length === 0) {
                        showNotification('警告', '导入数据为空或格式不正确，请检查表头和数据内容', 'warning');
                        return;
                    }
                    showNotification('成功', `已导入文件: ${file.name}`, 'success');
                    logOperation(`导入文件: ${file.name}`);
                    updateStepIndicator(2);
                } catch (error) {
                    console.error('文件解析错误:', error);
                    showNotification('错误', '文件解析失败，请检查文件格式', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // 填充工作表选择器
        function populateWorksheetSelector() {
            worksheetSelect.innerHTML = '';
            workbook.SheetNames.forEach(sheetName => {
                const option = document.createElement('option');
                option.value = sheetName;
                option.textContent = sheetName;
                worksheetSelect.appendChild(option);
            });
        }

        // 处理工作表切换
        function handleWorksheetChange() {
            currentWorksheet = worksheetSelect.value;
            loadWorksheetData(currentWorksheet);
            showNotification('成功', `已切换到工作表: ${currentWorksheet}`, 'info');
            logOperation(`切换到工作表: ${currentWorksheet}`);
        }

        // 加载工作表数据
        function loadWorksheetData(sheetName) {
            const worksheet = workbook.Sheets[sheetName];
            // 使用raw: false确保日期等格式被正确转换为字符串
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false });
            // 重置数据
            columns = [];
            originalData = [];
            // 智能检测第一行是否为表头
            let autoHeader = false;
            if (jsonData.length > 1) {
                const firstRow = jsonData[0];
                const secondRow = jsonData[1];
                const firstRowIsString = firstRow.every(cell => typeof cell === 'string' && cell.trim() !== '');
                const noRepeat = new Set(firstRow).size === firstRow.length;
                const secondRowHasNumber = secondRow.some(cell => typeof cell === 'number' || (!isNaN(cell) && cell !== ''));
                if (firstRowIsString && noRepeat && secondRowHasNumber) autoHeader = true;
            }
            // 优先使用用户设置，否则自动识别
            const useHeader = typeof useFirstRowAsHeader === 'boolean' ? useFirstRowAsHeader : autoHeader;
            if (jsonData.length > 0) {
                if (useHeader) {
                    // 提取标题行（第一行）作为列名
                    const headerRow = jsonData[0];
                    columns = headerRow.map((cell, index) => {
                        const cellValue = cell !== null && cell !== undefined ? String(cell).trim() : '';
                        return cellValue || `列${index + 1}`;
                    });
                    for (let i = 1; i < jsonData.length; i++) {
                        const dataRow = jsonData[i];
                        const rowObj = {};
                        columns.forEach((col, colIndex) => {
                            if (colIndex < dataRow.length) {
                                const cellValue = dataRow[colIndex];
                                rowObj[col] = cellValue !== null && cellValue !== undefined ? cellValue : '';
                            } else {
                                rowObj[col] = '';
                            }
                        });
                        originalData.push(rowObj);
                    }
                } else {
                    // 不使用标题行，自动生成列名
                    const columnCount = jsonData[0].length;
                    columns = Array.from({ length: columnCount }, (_, i) => `列${i + 1}`);
                    jsonData.forEach(dataRow => {
                        const rowObj = {};
                        columns.forEach((col, colIndex) => {
                            if (colIndex < dataRow.length) {
                                const cellValue = dataRow[colIndex];
                                rowObj[col] = cellValue !== null && cellValue !== undefined ? cellValue : '';
                            } else {
                                rowObj[col] = '';
                            }
                        });
                        originalData.push(rowObj);
                    });
                }
                currentData = JSON.parse(JSON.stringify(originalData));
            }
            // 检测列类型
            detectColumnTypes();
            // 更新UI
            renderTable();
            updateStatistics();
            populateChartColumnSelect();
            renderAvailableFields();
            renderDimensions();
            updateColumnTypeSelect();
        }

        // 渲染表格
        function renderTable() {
            // 清空表格
            const thead = dataTable.querySelector('thead');
            const tbody = dataTable.querySelector('tbody');
            thead.innerHTML = '';
            tbody.innerHTML = '';
            
            if (columns.length === 0 || currentData.length === 0) {
                rowCount.textContent = '0';
                colCount.textContent = '0';
                displayedRows.textContent = '0';
                showMoreBtn.disabled = true;
                return;
            }
            
            // 更新计数
            rowCount.textContent = currentData.length;
            colCount.textContent = columns.length;
            
            // 限制显示行数
            const displayData = currentData.slice(0, maxDisplayRows);
            displayedRows.textContent = displayData.length;
            showMoreBtn.disabled = maxDisplayRows >= currentData.length;
            
            // 创建表头
            const theadRow = document.createElement('tr');
            columns.forEach(col => {
                const th = document.createElement('th');
                th.textContent = col;
                th.className = 'px-4 py-2 text-left border-b border-gray-200 font-medium text-gray-700';
                // 添加列类型标识
                const typeBadge = document.createElement('span');
                typeBadge.className = 'ml-2 px-1.5 py-0.5 rounded text-xs';
                
                if (columnTypes[col] === 'number') {
                    typeBadge.className += ' bg-blue-100 text-blue-800';
                    typeBadge.textContent = '数值';
                } else if (columnTypes[col] === 'date') {
                    typeBadge.className += ' bg-green-100 text-green-800';
                    typeBadge.textContent = '日期';
                } else {
                    typeBadge.className += ' bg-gray-100 text-gray-800';
                    typeBadge.textContent = '文本';
                }
                
                th.appendChild(typeBadge);
                theadRow.appendChild(th);
            });
            thead.appendChild(theadRow);
            
            // 创建表体
            displayData.forEach((row, rowIndex) => {
                const tr = document.createElement('tr');
                tr.className = rowIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                
                columns.forEach(col => {
                    const td = document.createElement('td');
                    const cellValue = row[col] !== undefined && row[col] !== null ? row[col] : '';
                    td.textContent = cellValue;
                    td.className = 'px-4 py-2 border-b border-gray-200 text-sm';
                    tr.appendChild(td);
                });
                
                tbody.appendChild(tr);
            });
        }

        // 处理数据清洗操作
        function handleCleanAction(e) {
            if (currentData.length === 0) {
                showNotification('错误', '请先导入数据', 'error');
                return;
            }
            
            const action = e.currentTarget.dataset.action;
            let result = false;
            let message = '';
            
            switch (action) {
                case 'date-standard':
                    result = standardizeDates();
                    message = result ? '日期格式已标准化' : '没有可标准化的日期列';
                    break;
                case 'text-case':
                    result = convertTextCase();
                    message = result ? '文本已转换为小写' : '没有可转换的文本列';
                    break;
                case 'trim-spaces':
                    result = trimSpaces();
                    message = result ? '已去除多余空格' : '没有需要处理的空格';
                    break;
                case 'remove-special':
                    result = removeSpecialCharacters();
                    message = result ? '已移除特殊字符' : '没有需要处理的特殊字符';
                    break;
                case 'remove-na':
                    const count = removeMissingValues();
                    message = count > 0 ? `已删除 ${count} 行缺失值` : '没有发现缺失值';
                    result = count > 0;
                    break;
                case 'fill-mean':
                    result = fillWithMean();
                    message = result ? '已用平均值填充缺失值' : '没有可填充的数值列或无缺失值';
                    break;
                case 'fill-median':
                    result = fillWithMedian();
                    message = result ? '已用中位数填充缺失值' : '没有可填充的数值列或无缺失值';
                    break;
                case 'remove-duplicates':
                    const removed = removeDuplicates();
                    message = removed > 0 ? `已删除 ${removed} 行重复值` : '没有发现重复值';
                    result = removed > 0;
                    break;
                case 'detect-outliers':
                    const outliers = detectOutliers();
                    message = outliers > 0 ? `已标记 ${outliers} 个异常值` : '没有发现异常值';
                    result = outliers > 0;
                    break;
            }
            
            if (result) {
                renderTable();
                updateStatistics();
                logOperation(message);
                showNotification('成功', message, 'success');
                updateStepIndicator(3);
            } else {
                showNotification('信息', message, 'info');
            }
        }

        // 日期标准化
        function standardizeDates() {
            let changed = false;
            const dateColumns = [];
            
            // 检测可能是日期的列
            columns.forEach(col => {
                if (columnTypes[col] === 'date') {
                    dateColumns.push(col);
                }
            });
            
            // 标准化日期格式为YYYY-MM-DD
            dateColumns.forEach(col => {
                currentData.forEach(row => {
                    if (row[col]) {
                        const date = new Date(row[col]);
                        if (date.toString() !== 'Invalid Date') {
                            const year = date.getFullYear();
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const day = String(date.getDate()).padStart(2, '0');
                            row[col] = `${year}-${month}-${day}`;
                            changed = true;
                        }
                    }
                });
            });
            
            return changed;
        }

        // 文本大小写转换（转为小写）
        function convertTextCase() {
            let changed = false;
            columns.forEach(col => {
                // 只处理文本列
                if (columnTypes[col] === 'text') {
                    currentData.forEach(row => {
                        if (typeof row[col] === 'string') {
                            const original = row[col];
                            row[col] = original.toLowerCase();
                            if (original !== row[col]) changed = true;
                        }
                    });
                }
            });
            return changed;
        }

        // 去除空格
        function trimSpaces() {
            let changed = false;
            columns.forEach(col => {
                currentData.forEach(row => {
                    if (typeof row[col] === 'string') {
                        const original = row[col];
                        row[col] = original.trim();
                        if (original !== row[col]) changed = true;
                    }
                });
            });
            return changed;
        }

        // 移除特殊字符
        function removeSpecialCharacters() {
            let changed = false;
            const specialChars = /[`!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~]/;
            
            columns.forEach(col => {
                currentData.forEach(row => {
                    if (typeof row[col] === 'string' && specialChars.test(row[col])) {
                        const original = row[col];
                        row[col] = original.replace(specialChars, '');
                        if (original !== row[col]) changed = true;
                    }
                });
            });
            return changed;
        }

        // 删除缺失值
        function removeMissingValues() {
            const initialCount = currentData.length;
            currentData = currentData.filter(row => {
                // 检查行中是否有任何缺失值
                for (const col of columns) {
                    if (row[col] === '' || row[col] === null || row[col] === undefined) {
                        return false;
                    }
                }
                return true;
            });
            return initialCount - currentData.length;
        }

        // 填充平均值
        function fillWithMean() {
            let changed = false;
            
            columns.forEach(col => {
                // 只处理数值列
                if (columnTypes[col] === 'number') {
                    // 计算平均值
                    const values = [];
                    currentData.forEach(row => {
                        const num = parseFloat(row[col]);
                        if (!isNaN(num)) {
                            values.push(num);
                        }
                    });
                    
                    if (values.length > 0) {
                        const mean = values.reduce((sum, val) => sum + val, 0) / values.length;
                        
                        // 填充缺失值
                        currentData.forEach(row => {
                            if (row[col] === '' || row[col] === null || row[col] === undefined || isNaN(parseFloat(row[col]))) {
                                row[col] = mean.toFixed(2);
                                changed = true;
                            }
                        });
                    }
                }
            });
            
            return changed;
        }

        // 填充中位数
        function fillWithMedian() {
            let changed = false;
            
            columns.forEach(col => {
                // 只处理数值列
                if (columnTypes[col] === 'number') {
                    // 计算中位数
                    const values = [];
                    currentData.forEach(row => {
                        const num = parseFloat(row[col]);
                        if (!isNaN(num)) {
                            values.push(num);
                        }
                    });
                    
                    if (values.length > 0) {
                        values.sort((a, b) => a - b);
                        const mid = Math.floor(values.length / 2);
                        const median = values.length % 2 !== 0 ? values[mid] : (values[mid - 1] + values[mid]) / 2;
                        
                        // 填充缺失值
                        currentData.forEach(row => {
                            if (row[col] === '' || row[col] === null || row[col] === undefined || isNaN(parseFloat(row[col]))) {
                                row[col] = median.toFixed(2);
                                changed = true;
                            }
                        });
                    }
                }
            });
            
            return changed;
        }

        // 填充自定义值
        function applyCustomFill() {
            const column = fillColumnSelect.value;
            const value = fillValueInput.value;
            
            if (!column || value === undefined || value === null) {
                showNotification('错误', '请选择列并输入填充值', 'error');
                return;
            }
            
            let count = 0;
            currentData.forEach(row => {
                if (row[column] === '' || row[column] === null || row[column] === undefined) {
                    row[column] = value;
                    count++;
                }
            });
            
            customFillModal.classList.add('hidden');
            fillValueInput.value = '';
            
            if (count > 0) {
                renderTable();
                updateStatistics();
                const message = `已用自定义值填充 ${count} 个缺失值`;
                logOperation(message);
                showNotification('成功', message, 'success');
            } else {
                showNotification('信息', '没有发现缺失值', 'info');
            }
        }

        // 填充填充列选择器
        function populateFillColumnSelect() {
            fillColumnSelect.innerHTML = '';
            columns.forEach(col => {
                const option = document.createElement('option');
                option.value = col;
                option.textContent = col;
                fillColumnSelect.appendChild(option);
            });
        }

        // 删除重复值
        function removeDuplicates() {
            const initialCount = currentData.length;
            const seen = new Set();
            
            currentData = currentData.filter(row => {
                const key = JSON.stringify(row);
                if (seen.has(key)) {
                    return false;
                }
                seen.add(key);
                return true;
            });
            
            return initialCount - currentData.length;
        }

        // 检测异常值（使用标准差法）
        function detectOutliers() {
            let outlierCount = 0;
            
            columns.forEach(col => {
                // 只处理数值列
                if (columnTypes[col] === 'number') {
                    const values = [];
                    currentData.forEach(row => {
                        const num = parseFloat(row[col]);
                        if (!isNaN(num)) {
                            values.push(num);
                        }
                    });
                    
                    if (values.length >= 5) { // 需要足够的数据点来计算统计量
                        // 计算平均值和标准差
                        const mean = values.reduce((sum, val) => sum + val, 0) / values.length;
                        const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
                        const stdDev = Math.sqrt(variance);
                        
                        // 标记异常值（超出平均值±3个标准差）
                        currentData.forEach(row => {
                            const num = parseFloat(row[col]);
                            if (!isNaN(num) && (num < mean - 3 * stdDev || num > mean + 3 * stdDev)) {
                                row[col] = `[异常] ${num}`;
                                outlierCount++;
                            }
                        });
                    }
                }
            });
            
            return outlierCount;
        }

        // 处理计算函数
        function handleCalcFunction(e) {
            if (currentData.length === 0) {
                showNotification('错误', '请先导入数据', 'error');
                return;
            }
            
            const func = e.currentTarget.dataset.function;
            functionType.value = func;
            
            // 设置函数面板标题和描述
            let title = '';
            let description = '';
            
            switch (func) {
                case 'if':
                    title = 'IF函数配置';
                    description = '如果满足指定条件，则返回值1，否则返回值2。例如：如果"成绩">=60则返回"及格"，否则返回"不及格"。';
                    break;
                case 'countif':
                    title = 'COUNTIF函数配置';
                    description = '计算满足指定条件的单元格数量。例如：统计"销售额">1000的记录数。';
                    break;
                case 'sumif':
                    title = 'SUMIF函数配置';
                    description = '对满足指定条件的单元格求和。例如：计算"部门"为"销售部"的"工资"总和。';
                    break;
                case 'averageif':
                    title = 'AVERAGEIF函数配置';
                    description = '计算满足指定条件的单元格平均值。例如：计算"性别"为"男"的"年龄"平均值。';
                    break;
                case 'ifs':
                    title = 'IFS函数配置';
                    description = '检查多个条件并返回第一个满足条件的结果。例如：成绩>=90返回"优秀"，>=80返回"良好"等。';
                    break;
                case 'countifs':
                    title = 'COUNTIFS函数配置';
                    description = '计算同时满足多个条件的单元格数量。例如：统计"部门"为"市场部"且"入职年份">2020的员工数。';
                    break;
                case 'sumifs':
                    title = 'SUMIFS函数配置';
                    description = '对同时满足多个条件的单元格求和。例如：计算"地区"为"华东"且"月份"为"12月"的"销量"总和。';
                    break;
                case 'averageifs':
                    title = 'AVERAGEIFS函数配置';
                    description = '计算同时满足多个条件的单元格平均值。例如：计算"产品类别"为"电子产品"且"价格">=1000的"评分"平均值。';
                    break;
            }
            
            functionPanelTitle.textContent = title;
            functionDescription.textContent = description;
            
            // 生成函数参数表单
            generateFunctionParameters(func);
            
            // 显示函数面板
            functionPanel.classList.remove('hidden');
        }

        // 生成函数参数表单
        function generateFunctionParameters(func) {
            functionParameters.innerHTML = '';
            
            switch (func) {
                case 'if':
                    addParameter('条件列', 'conditionColumn', 'column');
                    addParameter('条件运算符', 'conditionOperator', 'operator');
                    addParameter('条件值', 'conditionValue', 'text');
                    addParameter('满足条件时的值', 'trueValue', 'text');
                    addParameter('不满足条件时的值', 'falseValue', 'text');
                    break;
                case 'countif':
                    addParameter('条件列', 'conditionColumn', 'column');
                    addParameter('条件运算符', 'conditionOperator', 'operator');
                    addParameter('条件值', 'conditionValue', 'text');
                    break;
                case 'sumif':
                    addParameter('条件列', 'conditionColumn', 'column');
                    addParameter('条件运算符', 'conditionOperator', 'operator');
                    addParameter('条件值', 'conditionValue', 'text');
                    addParameter('求和列', 'sumColumn', 'column');
                    break;
                case 'averageif':
                    addParameter('条件列', 'conditionColumn', 'column');
                    addParameter('条件运算符', 'conditionOperator', 'operator');
                    addParameter('条件值', 'conditionValue', 'text');
                    addParameter('平均值列', 'averageColumn', 'column');
                    break;
                case 'ifs':
                    addParameter('条件组 1 - 列', 'condition1Column', 'column');
                    addParameter('条件组 1 - 运算符', 'condition1Operator', 'operator');
                    addParameter('条件组 1 - 值', 'condition1Value', 'text');
                    addParameter('条件组 1 - 结果', 'result1Value', 'text');
                    
                    addParameter('条件组 2 - 列', 'condition2Column', 'column');
                    addParameter('条件组 2 - 运算符', 'condition2Operator', 'operator');
                    addParameter('条件组 2 - 值', 'condition2Value', 'text');
                    addParameter('条件组 2 - 结果', 'result2Value', 'text');
                    
                    addParameter('默认结果（所有条件不满足时）', 'defaultResult', 'text');
                    break;
                case 'countifs':
                    addParameter('条件组 1 - 列', 'condition1Column', 'column');
                    addParameter('条件组 1 - 运算符', 'condition1Operator', 'operator');
                    addParameter('条件组 1 - 值', 'condition1Value', 'text');
                    
                    addParameter('条件组 2 - 列', 'condition2Column', 'column');
                    addParameter('条件组 2 - 运算符', 'condition2Operator', 'operator');
                    addParameter('条件组 2 - 值', 'condition2Value', 'text');
                    break;
                case 'sumifs':
                    addParameter('求和列', 'sumColumn', 'column');
                    
                    addParameter('条件组 1 - 列', 'condition1Column', 'column');
                    addParameter('条件组 1 - 运算符', 'condition1Operator', 'operator');
                    addParameter('条件组 1 - 值', 'condition1Value', 'text');
                    
                    addParameter('条件组 2 - 列', 'condition2Column', 'column');
                    addParameter('条件组 2 - 运算符', 'condition2Operator', 'operator');
                    addParameter('条件组 2 - 值', 'condition2Value', 'text');
                    break;
                case 'averageifs':
                    addParameter('平均值列', 'averageColumn', 'column');
                    
                    addParameter('条件组 1 - 列', 'condition1Column', 'column');
                    addParameter('条件组 1 - 运算符', 'condition1Operator', 'operator');
                    addParameter('条件组 1 - 值', 'condition1Value', 'text');
                    
                    addParameter('条件组 2 - 列', 'condition2Column', 'column');
                    addParameter('条件组 2 - 运算符', 'condition2Operator', 'operator');
                    addParameter('条件组 2 - 值', 'condition2Value', 'text');
                    break;
            }
        }

        // 添加参数到表单
        function addParameter(label, name, type) {
            const paramGroup = document.createElement('div');
            paramGroup.className = 'param-group';
            
            const labelElem = document.createElement('label');
            labelElem.className = 'block text-sm font-medium text-gray-700 mb-1';
            labelElem.textContent = label;
            paramGroup.appendChild(labelElem);
            
            const inputContainer = document.createElement('div');
            
            switch (type) {
                case 'column':
                    const select = document.createElement('select');
                    select.name = name;
                    select.id = name;
                    select.className = 'w-full p-2 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary';
                    
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = '-- 选择列 --';
                    select.appendChild(defaultOption);
                    
                    columns.forEach(col => {
                        const option = document.createElement('option');
                        option.value = col;
                        option.textContent = col;
                        // 显示列类型
                        option.textContent += ` (${getTypeDisplayName(columnTypes[col])})`;
                        select.appendChild(option);
                    });
                    
                    inputContainer.appendChild(select);
                    break;
                case 'operator':
                    const operatorSelect = document.createElement('select');
                    operatorSelect.name = name;
                    operatorSelect.id = name;
                    operatorSelect.className = 'w-full p-2 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary';
                    
                    const operators = [
                        { value: 'eq', text: '等于 (=)' },
                        { value: 'ne', text: '不等于 (≠)' },
                        { value: 'gt', text: '大于 (>)' },
                        { value: 'gte', text: '大于等于 (≥)' },
                        { value: 'lt', text: '小于 (<)' },
                        { value: 'lte', text: '小于等于 (≤)' }
                    ];
                    
                    operators.forEach(op => {
                        const option = document.createElement('option');
                        option.value = op.value;
                        option.textContent = op.text;
                        operatorSelect.appendChild(option);
                    });
                    
                    inputContainer.appendChild(operatorSelect);
                    break;
                case 'text':
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.name = name;
                    input.id = name;
                    input.className = 'w-full p-2 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary';
                    inputContainer.appendChild(input);
                    break;
            }
            
            paramGroup.appendChild(inputContainer);
            functionParameters.appendChild(paramGroup);
        }

        // 处理函数提交
        function handleFunctionSubmit(e) {
            e.preventDefault();
            
            const func = functionType.value;
            const resultCol = resultColumnName.value.trim();
            
            if (!resultCol) {
                showNotification('错误', '请输入结果列名称', 'error');
                return;
            }
            
            if (columns.includes(resultCol)) {
                if (!confirm(`列名 "${resultCol}" 已存在，是否覆盖？`)) {
                    return;
                }
            } else {
                columns.push(resultCol);
                // 新列默认为文本类型
                columnTypes[resultCol] = 'text';
            }
            
            // 执行计算
            let success = false;
            let message = '';
            
            switch (func) {
                case 'if':
                    success = calculateIF(resultCol);
                    message = success ? `已应用IF函数，结果保存到 "${resultCol}"` : 'IF函数计算失败';
                    break;
                case 'countif':
                    success = calculateCOUNTIF(resultCol);
                    message = success ? `已应用COUNTIF函数，结果保存到 "${resultCol}"` : 'COUNTIF函数计算失败';
                    break;
                case 'sumif':
                    success = calculateSUMIF(resultCol);
                    message = success ? `已应用SUMIF函数，结果保存到 "${resultCol}"` : 'SUMIF函数计算失败';
                    break;
                case 'averageif':
                    success = calculateAVERAGEIF(resultCol);
                    message = success ? `已应用AVERAGEIF函数，结果保存到 "${resultCol}"` : 'AVERAGEIF函数计算失败';
                    break;
                case 'ifs':
                    success = calculateIFS(resultCol);
                    message = success ? `已应用IFS函数，结果保存到 "${resultCol}"` : 'IFS函数计算失败';
                    break;
                case 'countifs':
                    success = calculateCOUNTIFS(resultCol);
                    message = success ? `已应用COUNTIFS函数，结果保存到 "${resultCol}"` : 'COUNTIFS函数计算失败';
                    break;
                case 'sumifs':
                    success = calculateSUMIFS(resultCol);
                    message = success ? `已应用SUMIFS函数，结果保存到 "${resultCol}"` : 'SUMIFS函数计算失败';
                    break;
                case 'averageifs':
                    success = calculateAVERAGEIFS(resultCol);
                    message = success ? `已应用AVERAGEIFS函数，结果保存到 "${resultCol}"` : 'AVERAGEIFS函数计算失败';
                    break;
            }
            
            if (success) {
                functionPanel.classList.add('hidden');
                functionForm.reset();
                renderTable();
                updateStatistics();
                populateChartColumnSelect();
                renderAvailableFields();
                updateColumnTypeSelect();
                logOperation(message);
                showNotification('成功', message, 'success');
                updateStepIndicator(4);
            } else {
                showNotification('错误', message, 'error');
            }
        }

        // 处理计算预览
        function handlePreviewCalculation() {
            const func = functionType.value;
            const resultCol = resultColumnName.value.trim() || '预览结果';
            
            // 执行计算预览（只计算前5行）
            let previewData = [];
            let success = false;
            
            switch (func) {
                case 'if':
                    previewData = previewIF(resultCol);
                    success = previewData.length > 0;
                    break;
                case 'countif':
                    previewData = previewCOUNTIF(resultCol);
                    success = previewData.length > 0;
                    break;
                case 'sumif':
                    previewData = previewSUMIF(resultCol);
                    success = previewData.length > 0;
                    break;
                case 'averageif':
                    previewData = previewAVERAGEIF(resultCol);
                    success = previewData.length > 0;
                    break;
                case 'ifs':
                    previewData = previewIFS(resultCol);
                    success = previewData.length > 0;
                    break;
                case 'countifs':
                    previewData = previewCOUNTIFS(resultCol);
                    success = previewData.length > 0;
                    break;
                case 'sumifs':
                    previewData = previewSUMIFS(resultCol);
                    success = previewData.length > 0;
                    break;
                case 'averageifs':
                    previewData = previewAVERAGEIFS(resultCol);
                    success = previewData.length > 0;
                    break;
            }
            
            if (success && previewData.length > 0) {
                let previewHtml = '<div class="mt-4 p-3 bg-gray-50 rounded-lg"><h4 class="font-medium mb-2">计算结果预览（前5行）：</h4><table class="w-full text-sm"><thead><tr><th class="border border-gray-200 px-2 py-1 text-left">行号</th><th class="border border-gray-200 px-2 py-1 text-left">结果值</th></tr></thead><tbody>';
                
                previewData.forEach((item, index) => {
                    previewHtml += `<tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">`;
                    previewHtml += `<td class="border border-gray-200 px-2 py-1">${item.row + 1}</td>`;
                    previewHtml += `<td class="border border-gray-200 px-2 py-1">${item.value}</td>`;
                    previewHtml += '</tr>';
                });
                
                previewHtml += '</tbody></table></div>';
                
                // 移除已有的预览
                const existingPreview = document.querySelector('.calculation-preview');
                if (existingPreview) {
                    existingPreview.remove();
                }
                
                // 添加新预览
                const previewContainer = document.createElement('div');
                previewContainer.className = 'calculation-preview';
                previewContainer.innerHTML = previewHtml;
                functionForm.parentNode.insertBefore(previewContainer, functionForm.nextSibling);
            } else {
                showNotification('错误', '预览计算失败，请检查参数', 'error');
            }
        }

        // 计算函数实现 - IF
        function calculateIF(resultCol) {
            const conditionColumn = document.getElementById('conditionColumn').value;
            const conditionOperator = document.getElementById('conditionOperator').value;
            const conditionValue = document.getElementById('conditionValue').value;
            const trueValue = document.getElementById('trueValue').value;
            const falseValue = document.getElementById('falseValue').value;
            
            if (!conditionColumn || !conditionOperator || conditionValue === '' || trueValue === '' || falseValue === '') {
                return false;
            }
            
            currentData.forEach(row => {
                const value = row[conditionColumn];
                const satisfies = checkCondition(value, conditionOperator, conditionValue);
                row[resultCol] = satisfies ? trueValue : falseValue;
            });
            
            return true;
        }

        // 预览函数实现 - IF
        function previewIF(resultCol) {
            const conditionColumn = document.getElementById('conditionColumn').value;
            const conditionOperator = document.getElementById('conditionOperator').value;
            const conditionValue = document.getElementById('conditionValue').value;
            const trueValue = document.getElementById('trueValue').value;
            const falseValue = document.getElementById('falseValue').value;
            
            if (!conditionColumn || !conditionOperator || conditionValue === '' || trueValue === '' || falseValue === '') {
                return [];
            }
            
            const previewData = [];
            const previewRows = Math.min(currentData.length, 5);
            
            for (let i = 0; i < previewRows; i++) {
                const row = currentData[i];
                const value = row[conditionColumn];
                const satisfies = checkCondition(value, conditionOperator, conditionValue);
                previewData.push({
                    row: i,
                    value: satisfies ? trueValue : falseValue
                });
            }
            
            return previewData;
        }

        // 计算函数实现 - COUNTIF
        function calculateCOUNTIF(resultCol) {
            const conditionColumn = document.getElementById('conditionColumn').value;
            const conditionOperator = document.getElementById('conditionOperator').value;
            const conditionValue = document.getElementById('conditionValue').value;
            
            if (!conditionColumn || !conditionOperator || conditionValue === '') {
                return false;
            }
            
            // 计算满足条件的总数
            let count = 0;
            currentData.forEach(row => {
                const value = row[conditionColumn];
                if (checkCondition(value, conditionOperator, conditionValue)) {
                    count++;
                }
            });
            
            // 为每行设置相同的计数结果
            currentData.forEach(row => {
                row[resultCol] = count;
            });
            
            return true;
        }

        // 预览函数实现 - COUNTIF
        function previewCOUNTIF(resultCol) {
            const conditionColumn = document.getElementById('conditionColumn').value;
            const conditionOperator = document.getElementById('conditionOperator').value;
            const conditionValue = document.getElementById('conditionValue').value;
            
            if (!conditionColumn || !conditionOperator || conditionValue === '') {
                return [];
            }
            
            // 计算满足条件的总数
            let count = 0;
            currentData.forEach(row => {
                const value = row[conditionColumn];
                if (checkCondition(value, conditionOperator, conditionValue)) {
                    count++;
                }
            });
            
            const previewData = [];
            const previewRows = Math.min(currentData.length, 5);
            
            for (let i = 0; i < previewRows; i++) {
                previewData.push({
                    row: i,
                    value: count
                });
            }
            
            return previewData;
        }

        // 计算函数实现 - SUMIF
        function calculateSUMIF(resultCol) {
            const conditionColumn = document.getElementById('conditionColumn').value;
            const conditionOperator = document.getElementById('conditionOperator').value;
            const conditionValue = document.getElementById('conditionValue').value;
            const sumColumn = document.getElementById('sumColumn').value;
            
            // 检查求和列是否为数值类型
            if (columnTypes[sumColumn] !== 'number') {
                showNotification('错误', '求和列必须是数值类型', 'error');
                return false;
            }
            
            if (!conditionColumn || !conditionOperator || conditionValue === '' || !sumColumn) {
                return false;
            }
            
            // 计算满足条件的总和
            let sum = 0;
            currentData.forEach(row => {
                const value = row[conditionColumn];
                if (checkCondition(value, conditionOperator, conditionValue)) {
                    const num = parseFloat(row[sumColumn]);
                    if (!isNaN(num)) {
                        sum += num;
                    }
                }
            });
            
            // 为每行设置相同的求和结果
            currentData.forEach(row => {
                row[resultCol] = sum.toFixed(2);
            });
            
            return true;
        }

        // 预览函数实现 - SUMIF
        function previewSUMIF(resultCol) {
            const conditionColumn = document.getElementById('conditionColumn').value;
            const conditionOperator = document.getElementById('conditionOperator').value;
            const conditionValue = document.getElementById('conditionValue').value;
            const sumColumn = document.getElementById('sumColumn').value;
            
            // 检查求和列是否为数值类型
            if (columnTypes[sumColumn] !== 'number') {
                showNotification('错误', '求和列必须是数值类型', 'error');
                return [];
            }
            
            if (!conditionColumn || !conditionOperator || conditionValue === '' || !sumColumn) {
                return [];
            }
            
            // 计算满足条件的总和
            let sum = 0;
            currentData.forEach(row => {
                const value = row[conditionColumn];
                if (checkCondition(value, conditionOperator, conditionValue)) {
                    const num = parseFloat(row[sumColumn]);
                    if (!isNaN(num)) {
                        sum += num;
                    }
                }
            });
            
            const previewData = [];
            const previewRows = Math.min(currentData.length, 5);
            
            for (let i = 0; i < previewRows; i++) {
                previewData.push({
                    row: i,
                    value: sum.toFixed(2)
                });
            }
            
            return previewData;
        }

        // 计算函数实现 - AVERAGEIF
        function calculateAVERAGEIF(resultCol) {
            const conditionColumn = document.getElementById('conditionColumn').value;
            const conditionOperator = document.getElementById('conditionOperator').value;
            const conditionValue = document.getElementById('conditionValue').value;
            const averageColumn = document.getElementById('averageColumn').value;
            
            // 检查平均值列是否为数值类型
            if (columnTypes[averageColumn] !== 'number') {
                showNotification('错误', '平均值列必须是数值类型', 'error');
                return false;
            }
            
            if (!conditionColumn || !conditionOperator || conditionValue === '' || !averageColumn) {
                return false;
            }
            
            // 计算满足条件的平均值
            let sum = 0;
            let count = 0;
            
            currentData.forEach(row => {
                const value = row[conditionColumn];
                if (checkCondition(value, conditionOperator, conditionValue)) {
                    const num = parseFloat(row[averageColumn]);
                    if (!isNaN(num)) {
                        sum += num;
                        count++;
                    }
                }
            });
            
            const average = count > 0 ? sum / count : 0;
            
            // 为每行设置相同的平均值结果
            currentData.forEach(row => {
                row[resultCol] = average.toFixed(2);
            });
            
            return true;
        }

        // 预览函数实现 - AVERAGEIF
        function previewAVERAGEIF(resultCol) {
            const conditionColumn = document.getElementById('conditionColumn').value;
            const conditionOperator = document.getElementById('conditionOperator').value;
            const conditionValue = document.getElementById('conditionValue').value;
            const averageColumn = document.getElementById('averageColumn').value;
            
            // 检查平均值列是否为数值类型
            if (columnTypes[averageColumn] !== 'number') {
                showNotification('错误', '平均值列必须是数值类型', 'error');
                return [];
            }
            
            if (!conditionColumn || !conditionOperator || conditionValue === '' || !averageColumn) {
                return [];
            }
            
            // 计算满足条件的平均值
            let sum = 0;
            let count = 0;
            
            currentData.forEach(row => {
                const value = row[conditionColumn];
                if (checkCondition(value, conditionOperator, conditionValue)) {
                    const num = parseFloat(row[averageColumn]);
                    if (!isNaN(num)) {
                        sum += num;
                        count++;
                    }
                }
            });
            
            const average = count > 0 ? sum / count : 0;
            
            const previewData = [];
            const previewRows = Math.min(currentData.length, 5);
            
            for (let i = 0; i < previewRows; i++) {
                previewData.push({
                    row: i,
                    value: average.toFixed(2)
                });
            }
            
            return previewData;
        }

        // 计算函数实现 - IFS
        function calculateIFS(resultCol) {
            const condition1Column = document.getElementById('condition1Column').value;
            const condition1Operator = document.getElementById('condition1Operator').value;
            const condition1Value = document.getElementById('condition1Value').value;
            const result1Value = document.getElementById('result1Value').value;
            
            const condition2Column = document.getElementById('condition2Column').value;
            const condition2Operator = document.getElementById('condition2Operator').value;
            const condition2Value = document.getElementById('condition2Value').value;
            const result2Value = document.getElementById('result2Value').value;
            
            const defaultResult = document.getElementById('defaultResult').value;
            
            if (!condition1Column || !condition1Operator || condition1Value === '' || result1Value === '') {
                return false;
            }
            
            currentData.forEach(row => {
                // 检查第一个条件
                const value1 = row[condition1Column];
                if (checkCondition(value1, condition1Operator, condition1Value)) {
                    row[resultCol] = result1Value;
                    return;
                }
                
                // 检查第二个条件（如果提供）
                if (condition2Column && condition2Operator && condition2Value !== '' && result2Value !== '') {
                    const value2 = row[condition2Column];
                    if (checkCondition(value2, condition2Operator, condition2Value)) {
                        row[resultCol] = result2Value;
                        return;
                    }
                }
                
                // 默认结果
                row[resultCol] = defaultResult || '未匹配';
            });
            
            return true;
        }

        // 预览函数实现 - IFS
        function previewIFS(resultCol) {
            const condition1Column = document.getElementById('condition1Column').value;
            const condition1Operator = document.getElementById('condition1Operator').value;
            const condition1Value = document.getElementById('condition1Value').value;
            const result1Value = document.getElementById('result1Value').value;
            
            const condition2Column = document.getElementById('condition2Column').value;
            const condition2Operator = document.getElementById('condition2Operator').value;
            const condition2Value = document.getElementById('condition2Value').value;
            const result2Value = document.getElementById('result2Value').value;
            
            const defaultResult = document.getElementById('defaultResult').value;
            
            if (!condition1Column || !condition1Operator || condition1Value === '' || result1Value === '') {
                return [];
            }
            
            const previewData = [];
            const previewRows = Math.min(currentData.length, 5);
            
            for (let i = 0; i < previewRows; i++) {
                const row = currentData[i];
                let result;
                
                // 检查第一个条件
                const value1 = row[condition1Column];
                if (checkCondition(value1, condition1Operator, condition1Value)) {
                    result = result1Value;
                }
                // 检查第二个条件（如果提供）
                else if (condition2Column && condition2Operator && condition2Value !== '' && result2Value !== '') {
                    const value2 = row[condition2Column];
                    if (checkCondition(value2, condition2Operator, condition2Value)) {
                        result = result2Value;
                    } else {
                        result = defaultResult || '未匹配';
                    }
                } else {
                    result = defaultResult || '未匹配';
                }
                
                previewData.push({
                    row: i,
                    value: result
                });
            }
            
            return previewData;
        }

        // 其他计算函数的实现
        function calculateCOUNTIFS(resultCol) {
            const condition1Column = document.getElementById('condition1Column').value;
            const condition1Operator = document.getElementById('condition1Operator').value;
            const condition1Value = document.getElementById('condition1Value').value;
            
            const condition2Column = document.getElementById('condition2Column').value;
            const condition2Operator = document.getElementById('condition2Operator').value;
            const condition2Value = document.getElementById('condition2Value').value;
            
            if (!condition1Column || !condition1Operator || condition1Value === '' ||
                !condition2Column || !condition2Operator || condition2Value === '') {
                return false;
            }
            
            // 计算满足所有条件的总数
            let count = 0;
            currentData.forEach(row => {
                const value1 = row[condition1Column];
                const value2 = row[condition2Column];
                
                if (checkCondition(value1, condition1Operator, condition1Value) &&
                    checkCondition(value2, condition2Operator, condition2Value)) {
                    count++;
                }
            });
            
            // 为每行设置相同的计数结果
            currentData.forEach(row => {
                row[resultCol] = count;
            });
            
            return true;
        }

        function previewCOUNTIFS(resultCol) {
            // 实现COUNTIFS预览逻辑
            return [];
        }

        function calculateSUMIFS(resultCol) {
            // 实现SUMIFS逻辑
            return true;
        }

        function previewSUMIFS(resultCol) {
            // 实现SUMIFS预览逻辑
            return [];
        }

        function calculateAVERAGEIFS(resultCol) {
            // 实现AVERAGEIFS逻辑
            return true;
        }

        function previewAVERAGEIFS(resultCol) {
            // 实现AVERAGEIFS预览逻辑
            return [];
        }

        // 检查条件是否满足
        function checkCondition(value, operator, targetValue) {
            // 尝试将值转换为数字
            const numValue = parseFloat(value);
            const numTarget = parseFloat(targetValue);
            
            // 如果都是数字，使用数字比较
            if (!isNaN(numValue) && !isNaN(numTarget)) {
                switch (operator) {
                    case 'eq': return numValue === numTarget;
                    case 'ne': return numValue !== numTarget;
                    case 'gt': return numValue > numTarget;
                    case 'gte': return numValue >= numTarget;
                    case 'lt': return numValue < numTarget;
                    case 'lte': return numValue <= numTarget;
                    default: return false;
                }
            }
            
            // 否则使用字符串比较
            const strValue = String(value).toLowerCase();
            const strTarget = String(targetValue).toLowerCase();
            
            switch (operator) {
                case 'eq': return strValue === strTarget;
                case 'ne': return strValue !== strTarget;
                case 'gt': return strValue > strTarget;
                case 'gte': return strValue >= strTarget;
                case 'lt': return strValue < strTarget;
                case 'lte': return strValue <= strTarget;
                default: return false;
            }
        }

        // 导出为Excel
        function exportToExcel() {
            if (currentData.length === 0 || columns.length === 0) {
                showNotification('错误', '没有可导出的数据', 'error');
                return;
            }
            
            // 准备导出数据
            const exportData = [columns].concat(
                currentData.map(row => columns.map(col => row[col]))
            );
            
            const worksheet = XLSX.utils.aoa_to_sheet(exportData);
            const newWorkbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(newWorkbook, worksheet, '处理结果');
            
            // 生成并下载文件
            XLSX.writeFile(newWorkbook, '数据处理结果.xlsx');
            showNotification('成功', 'Excel文件已导出', 'success');
            logOperation('导出数据为Excel文件');
        }

        // 导出为CSV
        function exportToCsv() {
            if (currentData.length === 0 || columns.length === 0) {
                showNotification('错误', '没有可导出的数据', 'error');
                return;
            }
            
            // 准备CSV内容
            let csvContent = columns.join(',') + '\n';
            
            currentData.forEach(row => {
                const rowData = columns.map(col => {
                    const value = row[col];
                    // 处理包含逗号或引号的值
                    if (String(value).includes(',') || String(value).includes('"')) {
                        return `"${String(value).replace(/"/g, '""')}"`;
                    }
                    return value;
                });
                csvContent += rowData.join(',') + '\n';
            });
            
            // 创建并下载文件
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', '数据处理结果.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('成功', 'CSV文件已导出', 'success');
            logOperation('导出数据为CSV文件');
        }

        // 记录操作
        function logOperation(action) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            
            operationHistory.push({
                time: timeStr,
                action: action
            });
            
            // 更新操作日志UI
            const logItem = document.createElement('div');
            logItem.className = 'flex items-start';
            logItem.innerHTML = `
                <div class="text-xs text-gray-500 mr-2">${timeStr}</div>
                <div class="text-sm">${action}</div>
            `;
            
            // 如果是第一条记录，先清空"操作记录将显示在这里..."
            if (operationHistory.length === 1) {
                operationLog.innerHTML = '';
            }
            
            operationLog.appendChild(logItem);
            operationLog.scrollTop = operationLog.scrollHeight;
            
            // 更新统计数据
            updateStatistics();
        }

        // 更新统计数据
        function updateStatistics() {
            // 更新总行数
            totalRows.textContent = currentData.length;
            
            // 更新处理步骤数
            processSteps.textContent = operationHistory.length;
            
            // 计算数值列的平均值
            let numericColumns = [];
            columns.forEach(col => {
                if (columnTypes[col] === 'number') {
                    numericColumns.push(col);
                }
            });
            
            // 计算所有数值列的平均值
            if (numericColumns.length > 0 && currentData.length > 0) {
                let totalSum = 0;
                let totalCount = 0;
                
                numericColumns.forEach(col => {
                    currentData.forEach(row => {
                        const num = parseFloat(row[col]);
                        if (!isNaN(num)) {
                            totalSum += num;
                            totalCount++;
                        }
                    });
                });
                
                if (totalCount > 0) {
                    avgValue.textContent = (totalSum / totalCount).toFixed(2);
                } else {
                    avgValue.textContent = '-';
                }
            } else {
                avgValue.textContent = '-';
            }
        }

        // 显示通知
        function showNotification(title, message, type = 'info') {
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            
            // 设置图标和样式
            switch (type) {
                case 'success':
                    notificationIcon.className = 'fa fa-check-circle text-success';
                    notification.className = 'fixed bottom-4 right-4 p-4 rounded-lg shadow-lg bg-white border-l-4 border-success transform translate-y-0 opacity-100 transition-all duration-300 z-50 max-w-sm';
                    break;
                case 'error':
                    notificationIcon.className = 'fa fa-exclamation-circle text-danger';
                    notification.className = 'fixed bottom-4 right-4 p-4 rounded-lg shadow-lg bg-white border-l-4 border-danger transform translate-y-0 opacity-100 transition-all duration-300 z-50 max-w-sm';
                    break;
                case 'warning':
                    notificationIcon.className = 'fa fa-exclamation-triangle text-warning';
                    notification.className = 'fixed bottom-4 right-4 p-4 rounded-lg shadow-lg bg-white border-l-4 border-warning transform translate-y-0 opacity-100 transition-all duration-300 z-50 max-w-sm';
                    break;
                default:
                    notificationIcon.className = 'fa fa-info-circle text-primary';
                    notification.className = 'fixed bottom-4 right-4 p-4 rounded-lg shadow-lg bg-white border-l-4 border-primary transform translate-y-0 opacity-100 transition-all duration-300 z-50 max-w-sm';
            }
            
            // 5秒后自动隐藏
            setTimeout(hideNotification, 5000);
        }

        // 隐藏通知
        function hideNotification() {
            notification.className = 'fixed bottom-4 right-4 p-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50 max-w-sm';
        }

        // 更新步骤指示器
        function updateStepIndicator(step) {
            document.querySelectorAll('.step-item').forEach(item => {
                const itemStep = parseInt(item.dataset.step);
                const circle = item.querySelector('div');
                
                if (itemStep < step) {
                    // 已完成的步骤
                    circle.className = 'w-8 h-8 rounded-full bg-success text-white flex items-center justify-center mr-2';
                    item.querySelector('span').className = 'font-medium text-success';
                } else if (itemStep === step) {
                    // 当前步骤
                    circle.className = 'w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center mr-2';
                    item.querySelector('span').className = 'font-medium text-primary';
                } else {
                    // 未完成的步骤
                    circle.className = 'w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center mr-2';
                    item.querySelector('span').className = '';
                }
            });
        }

        // 添加手动数据行
        function addManualDataRow() {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'flex items-center';
            rowDiv.innerHTML = `
                <input type="text" class="manual-row-input w-full p-2 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary" placeholder="用逗号分隔一行数据">
            `;
            manualDataRows.appendChild(rowDiv);
        }

        // 移除手动数据行
        function removeManualDataRow() {
            if (manualDataRows.children.length > 1) {
                manualDataRows.removeChild(manualDataRows.lastChild);
            } else {
                showNotification('提示', '至少保留一行数据', 'info');
            }
        }

        // 应用手动输入的数据
        function applyManualData() {
            const columnNames = columnNamesInput.value.trim();
            if (!columnNames) {
                showNotification('错误', '请输入列名', 'error');
                return;
            }
            const cols = columnNames.split(',').map(col => col.trim());
            if (cols.some(col => !col)) {
                showNotification('错误', '列名不能为空', 'error');
                return;
            }
            const rowInputs = document.querySelectorAll('.manual-row-input');
            const data = [];
            rowInputs.forEach(input => {
                const value = input.value.trim();
                if (value) {
                    const rowData = value.split(',');
                    if (rowData.length !== cols.length) {
                        showNotification('警告', '数据行与列名数量不一致，已自动补齐空值', 'warning');
                    }
                    const rowObj = {};
                    cols.forEach((col, index) => {
                        rowObj[col] = rowData[index] !== undefined ? rowData[index].trim() : '';
                    });
                    data.push(rowObj);
                }
            });
            if (data.length === 0) {
                showNotification('错误', '请输入至少一行数据', 'error');
                return;
            }
            // 数据内容校验
            if (cols.length === 0 || data.length === 0) {
                showNotification('警告', '导入数据为空或格式不正确，请检查列名和数据内容', 'warning');
                return;
            }
            // 更新数据
            columns = cols;
            originalData = JSON.parse(JSON.stringify(data));
            currentData = JSON.parse(JSON.stringify(data));
            // 检测列类型
            detectColumnTypes();
            // 更新UI
            manualInputModal.classList.add('hidden');
            columnNamesInput.value = '';
            manualDataRows.innerHTML = `
                <div class="flex items-center">
                    <input type="text" class="manual-row-input w-full p-2 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary" placeholder="用逗号分隔一行数据">
                </div>
                <div class="flex items-center">
                    <input type="text" class="manual-row-input w-full p-2 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary" placeholder="用逗号分隔一行数据">
                </div>
            `;
            renderTable();
            updateStatistics();
            populateChartColumnSelect();
            renderAvailableFields();
            updateColumnTypeSelect();
            showNotification('成功', '已导入手动输入的数据', 'success');
            logOperation('手动输入数据导入');
            updateStepIndicator(2);
        }

        // 检测列类型 - 优化版本
        function detectColumnTypes() {
            columnTypes = {};
            
            if (columns.length === 0 || currentData.length === 0) return;
            
            columns.forEach(col => {
                let isNumber = true;
                let isDate = false;
                let dateCount = 0;
                let numericCount = 0;
                let emptyCount = 0;
                
                // 检查前30行数据来判断类型，增加样本量提高准确性
                const sampleSize = Math.min(30, currentData.length);
                const sampleData = currentData.slice(0, sampleSize);
                
                sampleData.forEach(row => {
                    const value = row[col];
                    const strValue = String(value).trim();
                    
                    // 空值不影响类型判断，但计数以便计算有效数据比例
                    if (strValue === '') {
                        emptyCount++;
                        return;
                    }
                    
                    // 检查是否为数字
                    if (!isNaN(Number(strValue))) {
                        numericCount++;
                    } else {
                        isNumber = false;
                    }
                    
                    // 检查是否为日期
                    if (!isNaN(Date.parse(strValue))) {
                        dateCount++;
                        isDate = true;
                    }
                });
                
                // 有效数据比例
                const validDataRatio = (sampleSize - emptyCount) / sampleSize;
                
                // 如果有效数据不足30%，无法可靠判断类型
                if (validDataRatio < 0.3) {
                    columnTypes[col] = 'text';
                    return;
                }
                
                // 如果超过60%是日期，则判断为日期类型
                if (dateCount / (sampleSize - emptyCount) > 0.6) {
                    columnTypes[col] = 'date';
                } 
                // 如果超过70%是数字，则判断为数字类型
                else if (numericCount / (sampleSize - emptyCount) > 0.7) {
                    columnTypes[col] = 'number';
                } 
                // 否则为文本类型
                else {
                    columnTypes[col] = 'text';
                }
            });
        }
        
        // 渲染可用字段
        function renderAvailableFields() {
            availableFields.innerHTML = '';
            
            if (columns.length === 0) {
                availableFields.innerHTML = '<div class="text-sm text-gray-500 italic">请先导入数据</div>';
                return;
            }
            
            // 过滤掉已在维度中的字段
            const available = columns.filter(col => 
                !rowDimensions.includes(col) && !valueDimensions.includes(col)
            );
            
            if (available.length === 0) {
                availableFields.innerHTML = '<div class="text-sm text-gray-500 italic">所有字段已用于分析</div>';
                return;
            }
            
            available.forEach(col => {
                const fieldEl = document.createElement('div');
                fieldEl.className = 'draggable-field p-2 mb-1 bg-white border border-gray-200 rounded text-sm flex items-center justify-between';
                fieldEl.draggable = true;
                fieldEl.dataset.field = col;
                
                // 根据字段类型添加不同的图标
                let typeIcon = '';
                if (columnTypes[col] === 'number') {
                    typeIcon = '<span class="field-type-icon bg-blue-100 text-blue-600"><i class="fa fa-hashtag"></i></span>';
                } else if (columnTypes[col] === 'date') {
                    typeIcon = '<span class="field-type-icon bg-green-100 text-green-600"><i class="fa fa-calendar"></i></span>';
                } else {
                    typeIcon = '<span class="field-type-icon bg-gray-100 text-gray-600"><i class="fa fa-font"></i></span>';
                }
                
                fieldEl.innerHTML = `
                    ${typeIcon}
                    <span>${col}</span>
                `;
                
                fieldEl.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', col);
                    setTimeout(() => {
                        fieldEl.classList.add('opacity-50');
                    }, 0);
                });
                
                fieldEl.addEventListener('dragend', function() {
                    fieldEl.classList.remove('opacity-50');
                });
                
                availableFields.appendChild(fieldEl);
            });
        }
        
        // 渲染维度区域
        function renderDimensions() {
            // 渲染行维度
            renderDimensionArea(rowDimensionsContainer, rowDimensions, 'row');
            
            // 渲染值维度
            renderDimensionArea(valueDimensionsContainer, valueDimensions, 'value');
            
            // 更新按钮状态
            const hasData = rowDimensions.length > 0 && valueDimensions.length > 0;
            refreshChartBtn.disabled = !hasData;
            exportChartBtn.disabled = !hasData || !pivotChartInstance;
            
            // 显示/隐藏图表占位符
            chartPlaceholder.style.display = hasData ? 'none' : 'flex';
        }
        
        // 渲染单个维度区域
        function renderDimensionArea(container, dimensions, type) {
            if (dimensions.length === 0) {
                container.innerHTML = type === 'row' 
                    ? '<div class="text-sm text-gray-500 italic">拖拽字段到此处</div>'
                    : '<div class="text-sm text-gray-500 italic">拖拽数值字段到此处</div>';
                return;
            }
            
            container.innerHTML = '';
            dimensions.forEach((field, index) => {
                const fieldEl = document.createElement('div');
                fieldEl.className = 'p-2 mb-1 bg-white border border-gray-200 rounded text-sm flex items-center justify-between';
                fieldEl.dataset.field = field;
                
                // 根据字段类型添加不同的图标
                let typeIcon = '';
                if (columnTypes[field] === 'number') {
                    typeIcon = '<span class="field-type-icon bg-blue-100 text-blue-600"><i class="fa fa-hashtag"></i></span>';
                } else if (columnTypes[field] === 'date') {
                    typeIcon = '<span class="field-type-icon bg-green-100 text-green-600"><i class="fa fa-calendar"></i></span>';
                } else {
                    typeIcon = '<span class="field-type-icon bg-gray-100 text-gray-600"><i class="fa fa-font"></i></span>';
                }
                
                fieldEl.innerHTML = `
                    ${typeIcon}
                    <span>${field}</span>
                    <button class="remove-dimension text-gray-400 hover:text-danger" data-type="${type}" data-index="${index}">
                        <i class="fa fa-times"></i>
                    </button>
                `;
                
                container.appendChild(fieldEl);
            });
            
            // 添加删除维度事件
            container.querySelectorAll('.remove-dimension').forEach(btn => {
                btn.addEventListener('click', function() {
                    const type = this.dataset.type;
                    const index = parseInt(this.dataset.index);
                    
                    if (type === 'row') {
                        rowDimensions.splice(index, 1);
                    } else {
                        valueDimensions.splice(index, 1);
                    }
                    
                    renderAvailableFields();
                    renderDimensions();
                    updatePivotAnalysis();
                });
            });
        }
        
        // 拖放相关函数
        function highlightDimensionArea(type, highlight) {
            const container = type === 'row' ? rowDimensionsContainer : valueDimensionsContainer;
            if (highlight) {
                container.classList.add('dimension-area-active');
            } else {
                container.classList.remove('dimension-area-active');
            }
        }
        
        function dropField(event, type) {
            event.preventDefault();
            highlightDimensionArea(type, false);
            
            const field = event.dataTransfer.getData('text/plain');
            
            // 检查是否为有效的字段
            if (!columns.includes(field)) return;
            
            // 检查是否已在其他维度中
            if (rowDimensions.includes(field) || valueDimensions.includes(field)) return;
            
            // 如果是值维度，检查是否为数值类型
            if (type === 'value' && columnTypes[field] !== 'number') {
                showNotification('警告', '值维度仅支持数值类型字段。您可以在"数据清洗"区域手动将该列设置为数值类型。', 'warning');
                return;
            }
            
            // 添加到相应的维度
            if (type === 'row') {
                rowDimensions.push(field);
            } else {
                valueDimensions.push(field);
            }
            
            // 重新渲染
            renderAvailableFields();
            renderDimensions();
            updatePivotAnalysis();
        }
        
        // 清除所有维度
        function clearDimensions() {
            rowDimensions = [];
            valueDimensions = [];
            
            renderAvailableFields();
            renderDimensions();
            updatePivotAnalysis();
        }
        
        // 更新透视分析结果
        function updatePivotAnalysis() {
            if (rowDimensions.length === 0 || valueDimensions.length === 0) {
                pivotTable.innerHTML = `
                    <thead><tr class="bg-gray-50"></tr></thead>
                    <tbody>
                        <tr>
                            <td colspan="100%" class="text-center py-8 text-gray-400">
                                配置维度后显示透视表数据
                            </td>
                        </tr>
                    </tbody>
                `;
                
                if (pivotChartInstance) {
                    pivotChartInstance.destroy();
                    pivotChartInstance = null;
                }
                
                return;
            }
            
            // 计算透视数据
            const pivotData = calculatePivotData();
            
            // 渲染透视表
            renderPivotTable(pivotData);
            
            // 渲染图表
            renderPivotChart(pivotData);
        }
        
        // 计算透视数据
        function calculatePivotData() {
            const result = {};
            
            // 按行维度分组并计算值维度的聚合值
            currentData.forEach(row => {
                // 创建行维度键
                const rowKey = rowDimensions.map(dim => row[dim]).join('||');
                
                // 如果键不存在则初始化
                if (!result[rowKey]) {
                    result[rowKey] = {
                        dimensions: rowDimensions.reduce((obj, dim) => {
                            obj[dim] = row[dim];
                            return obj;
                        }, {}),
                        values: {}
                    };
                    
                    // 初始化值维度计数器
                    valueDimensions.forEach(valueDim => {
                        result[rowKey].values[valueDim] = {
                            sum: 0,
                            count: 0,
                            total: 0,
                            max: -Infinity,
                            min: Infinity
                        };
                    });
                }
                
                // 更新值维度数据
                valueDimensions.forEach(valueDim => {
                    const value = parseFloat(row[valueDim]) || 0;
                    const valueData = result[rowKey].values[valueDim];
                    
                    valueData.sum += value;
                    valueData.count += 1;
                    valueData.total += value;
                    valueData.max = Math.max(valueData.max, value);
                    valueData.min = Math.min(valueData.min, value);
                });
            });
            
            // 转换为数组并计算派生指标
            return Object.values(result).map(item => {
                valueDimensions.forEach(valueDim => {
                    const valueData = item.values[valueDim];
                    // 计算平均值
                    valueData.average = valueData.count > 0 ? valueData.total / valueData.count : 0;
                });
                return item;
            });
        }
        
        // 渲染透视表
        function renderPivotTable(pivotData) {
            // 清空表格
            pivotTable.innerHTML = '';
            
            // 创建表头
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            headerRow.className = 'bg-gray-50';
            
            // 添加行维度表头
            rowDimensions.forEach(dim => {
                const th = document.createElement('th');
                th.className = 'px-4 py-2 text-left border-b border-gray-200';
                th.textContent = dim;
                headerRow.appendChild(th);
            });
            
            // 添加值维度表头
            valueDimensions.forEach(valueDim => {
                const aggregationLabel = getAggregationLabel(currentAggregation);
                const th = document.createElement('th');
                th.className = 'px-4 py-2 text-left border-b border-gray-200';
                th.textContent = `${valueDim} (${aggregationLabel})`;
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            pivotTable.appendChild(thead);
            
            // 创建表体
            const tbody = document.createElement('tbody');
            
            if (pivotData.length === 0) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = rowDimensions.length + valueDimensions.length;
                td.className = 'text-center py-8 text-gray-400';
                td.textContent = '没有数据';
                tr.appendChild(td);
                tbody.appendChild(tr);
            } else {
                pivotData.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50';
                    
                    // 添加行维度数据
                    rowDimensions.forEach(dim => {
                        const td = document.createElement('td');
                        td.className = 'px-4 py-2 border-b border-gray-200';
                        td.textContent = item.dimensions[dim] || '';
                        tr.appendChild(td);
                    });
                    
                    // 添加值维度数据
                    valueDimensions.forEach(valueDim => {
                        const td = document.createElement('td');
                        td.className = 'px-4 py-2 border-b border-gray-200';
                        
                        // 根据当前聚合方式显示对应的值
                        const value = item.values[valueDim][currentAggregation];
                        td.textContent = currentAggregation === 'average' ? value.toFixed(2) : value;
                        tr.appendChild(td);
                    });
                    
                    tbody.appendChild(tr);
                });
            }
            
            pivotTable.appendChild(tbody);
        }
        
        // 渲染透视图表
        function renderPivotChart(pivotData) {
            // 销毁现有图表
            if (pivotChartInstance) {
                pivotChartInstance.destroy();
            }
            
            const ctx = pivotChart.getContext('2d');
            
            // 准备图表数据
            const chartType = pivotChartTypeSelect.value;
            
            // 处理标签 - 组合所有行维度
            const labels = pivotData.map(item => 
                rowDimensions.map(dim => item.dimensions[dim]).join(' - ')
            );
            
            // 处理数据集
            const datasets = valueDimensions.map((valueDim, index) => {
                // 生成不同的颜色
                const color = getDatasetColor(index);
                
                return {
                    label: valueDim,
                    data: pivotData.map(item => item.values[valueDim][currentAggregation]),
                    backgroundColor: chartType === 'pie' || chartType === 'doughnut' || chartType === 'polarArea' 
                        ? labels.map((_, i) => getDatasetColor(i))
                        : color + '80', // 添加透明度
                    borderColor: chartType === 'pie' || chartType === 'doughnut' || chartType === 'polarArea'
                        ? '#fff'
                        : color,
                    borderWidth: 1
                };
            });
            
            // 图表配置
            const config = {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: `数据透视分析 (${getAggregationLabel(currentAggregation)})`
                        }
                    },
                    scales: chartType !== 'pie' && chartType !== 'doughnut' && chartType !== 'polarArea' ? {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: getAggregationLabel(currentAggregation)
                            }
                        }
                    } : {}
                }
            };
            
            // 特殊图表类型的额外配置
            if (chartType === 'radar') {
                config.options.scales = {
                    r: {
                        beginAtZero: true,
                        ticks: {
                            display: false
                        }
                    }
                };
            }
            
            // 创建图表
            pivotChartInstance = new Chart(ctx, config);
            
            // 更新导出按钮状态
            exportChartBtn.disabled = false;
        }
        
        // 导出图表为PNG
        function exportChartAsPNG() {
            if (!pivotChartInstance) return;
            
            html2canvas(pivotChart).then(canvas => {
                // 创建下载链接
                const link = document.createElement('a');
                link.download = `图表-${new Date().getTime()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                showNotification('成功', '图表已导出为PNG图片', 'success');
            }).catch(err => {
                console.error('导出图表失败:', err);
                showNotification('错误', '导出图表失败，请重试', 'error');
            });
        }
        
        // 辅助函数：获取聚合方式的显示名称
        function getAggregationLabel(aggregation) {
            const labels = {
                'sum': '求和',
                'average': '平均值',
                'count': '计数',
                'max': '最大值',
                'min': '最小值'
            };
            return labels[aggregation] || aggregation;
        }
        
        // 辅助函数：生成数据集颜色
        function getDatasetColor(index) {
            const colors = [
                '#165DFF', '#36CFC9', '#52C41A', '#FAAD14', '#FF4D4F', 
                '#722ED1', '#EB0AA4', '#86909C', '#0FC6C2', '#7BC616'
            ];
            return colors[index % colors.length];
        }

        // 填充图表列选择器
        function populateChartColumnSelect() {
            chartColumnSelect.innerHTML = '';
            
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '-- 选择列 --';
            chartColumnSelect.appendChild(defaultOption);
            
            columns.forEach(col => {
                // 显示列类型
                let optionText = `${col} (${getTypeDisplayName(columnTypes[col])})`;
                const option = document.createElement('option');
                option.value = col;
                option.textContent = optionText;
                chartColumnSelect.appendChild(option);
            });
        }

        // 生成图表
        function generateChart() {
            const column = chartColumnSelect.value;
            const chartType = chartTypeSelect.value;
            
            if (!column) {
                showNotification('错误', '请选择要可视化的列', 'error');
                return;
            }
            
            // 准备图表数据
            const labels = [];
            const data = [];
            
            // 检查是否为数值列
            const isNumeric = columnTypes[column] === 'number';
            
            if (isNumeric) {
                // 数值列 - 使用前20行数据
                const maxItems = Math.min(currentData.length, 20);
                for (let i = 0; i < maxItems; i++) {
                    labels.push(`行 ${i + 1}`);
                    data.push(parseFloat(currentData[i][column]) || 0);
                }
            } else {
                // 文本列 - 统计每个值的出现次数
                const valueCounts = {};
                currentData.forEach(row => {
                    const value = row[column] || '空值';
                    valueCounts[value] = (valueCounts[value] || 0) + 1;
                });
                
                // 限制最多显示10个类别
                const sortedValues = Object.entries(valueCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);
                
                sortedValues.forEach(([value, count]) => {
                    labels.push(value);
                    data.push(count);
                });
            }
            
            // 销毁现有图表
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            // 创建新图表
            const ctx = dataChart.getContext('2d');
            chartInstance = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: column,
                        data: data,
                        backgroundColor: [
                            'rgba(22, 93, 255, 0.7)',
                            'rgba(54, 207, 201, 0.7)',
                            'rgba(82, 196, 26, 0.7)',
                            'rgba(250, 173, 20, 0.7)',
                            'rgba(255, 77, 79, 0.7)',
                            'rgba(140, 140, 140, 0.7)',
                            'rgba(123, 97, 255, 0.7)',
                            'rgba(255, 117, 157, 0.7)',
                            'rgba(77, 182, 172, 0.7)',
                            'rgba(148, 159, 177, 0.7)'
                        ],
                        borderColor: [
                            'rgba(22, 93, 255, 1)',
                            'rgba(54, 207, 201, 1)',
                            'rgba(82, 196, 26, 1)',
                            'rgba(250, 173, 20, 1)',
                            'rgba(255, 77, 79, 1)',
                            'rgba(140, 140, 140, 1)',
                            'rgba(123, 97, 255, 1)',
                            'rgba(255, 117, 157, 1)',
                            'rgba(77, 182, 172, 1)',
                            'rgba(148, 159, 177, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: chartType !== 'pie' ? {
                        y: {
                            beginAtZero: true
                        }
                    } : {}
                }
            });
        }
    </script>
</body>
</html>
